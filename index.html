<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ailin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ailin的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="ailin">
<meta property="og:url" content="http://dengal3.github.com/index.html">
<meta property="og:site_name" content="ailin">
<meta property="og:description" content="ailin的博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ailin">
<meta name="twitter:description" content="ailin的博客">
  
    <link rel="alternative" href="/atom.xml" title="ailin" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/logo.jpg">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="images/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ailin</a></h1>
		</hgroup>

		
		<p class="header-subtitle">其实这是流水账</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dengal3" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1793490742" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dengal" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Jquery/" style="font-size: 10px;">Jquery</a><a href="/tags/chrome-extension/" style="font-size: 10px;">chrome extension</a><a href="/tags/css/" style="font-size: 20px;">css</a><a href="/tags/hexo/" style="font-size: 10px;">hexo</a><a href="/tags/javascipt/" style="font-size: 10px;">javascipt</a><a href="/tags/javascript/" style="font-size: 20px;">javascript</a><a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a><a href="/tags/js/" style="font-size: 20px;">js</a><a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a><a href="/tags/nginx/" style="font-size: 10px;">nginx</a><a href="/tags/notes/" style="font-size: 10px;">notes</a><a href="/tags/object-oriented/" style="font-size: 10px;">object-oriented</a><a href="/tags/os/" style="font-size: 10px;">os</a><a href="/tags/pintos/" style="font-size: 20px;">pintos</a><a href="/tags/setTimeout/" style="font-size: 10px;">setTimeout</a><a href="/tags/thinking/" style="font-size: 20px;">thinking</a><a href="/tags/thread/" style="font-size: 10px;">thread</a><a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a><a href="/tags/假期/" style="font-size: 20px;">假期</a><a href="/tags/基本功/" style="font-size: 10px;">基本功</a><a href="/tags/外排序/" style="font-size: 10px;">外排序</a><a href="/tags/学习记录/" style="font-size: 10px;">学习记录</a><a href="/tags/定时器/" style="font-size: 10px;">定时器</a><a href="/tags/布局/" style="font-size: 20px;">布局</a><a href="/tags/数据库/" style="font-size: 20px;">数据库</a><a href="/tags/日常/" style="font-size: 10px;">日常</a><a href="/tags/服务器/" style="font-size: 10px;">服务器</a><a href="/tags/树结构索引/" style="font-size: 10px;">树结构索引</a><a href="/tags/浏览器原理/" style="font-size: 10px;">浏览器原理</a><a href="/tags/源码剖析/" style="font-size: 10px;">源码剖析</a><a href="/tags/笔记/" style="font-size: 10px;">笔记</a><a href="/tags/面试/" style="font-size: 10px;">面试</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://daixuan.me">DX的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://54017.github.io">017的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">你希望能看到什么?</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ailin</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="images/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">ailin</h1>
			</hgroup>
			
			<p class="header-subtitle">其实这是流水账</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dengal3" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1793490742" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dengal" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-2016-04-10-MVVM学习" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/12/2016-04-10-MVVM学习/" class="article-date">
  	<time datetime="2016-04-11T16:16:20.286Z" itemprop="datePublished">2016-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>title: “mvvm学习”<br>date: 2016-04-10<br>tags:</p>
<ul>
<li>框架</li>
<li>js</li>
<li><h1 id="mvvm">mvvm</h1></li>
</ul>
<p>最近想做百度前端学院很久之前布置的那个mvvm表单框架，但是想了挺久，总是感觉还是有些地方不对劲，代码也是写了又删，所以还是决定多看一下资料再去写。</p>
<p>因为之前写todo的时候用的是模拟mvc框架的工作流程来写的，中间发现了一个问题就是如果view中的数据是相互绑定的话，在mvc也是会再次通过controller到model，然后在model那里触发另一个view模块下的改变，其实这是很没有必要的。</p>
<p>mvvm框架的一个常见的功能就是数据的双向绑定，即多个绑定的view之间是相互触发的，这是由viewmodel来提供这个功能的。</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//      [<span class="atom">view</span>]  [<span class="atom">view</span>] [<span class="atom">view</span>]</span><br><span class="line">//         |      |       |</span><br><span class="line">//      [       <span class="atom">viewModel</span>            ]</span><br><span class="line">//              |       |</span><br><span class="line">//          [<span class="atom">model</span>]    [<span class="atom">model</span>]</span><br></pre></td></tr></table></figure>
<p>在我眼里，mvvm就是这样的架构。只是viewmodel不同于传统的mvc中的c，viewmodel还兼顾了view与view之间的数据绑定。</p>
<p>这里就要提及一般mvvm框架中常用的方法</p>
<ul>
<li>Object.defineProperties</li>
<li>Mututaion Observer<br>前者是用来做model到view的，后者是用来做view到默认的</li>
</ul>
<p>【未完待续】</p>
<p>相关链接：</p>
<ul>
<li><a href="http://gejiawen.github.io/2015/04/02/2-way-data-binding-and-define-property/" target="_blank" rel="external">JS中的双向数据绑定及Object.defineProperty方法</a></li>
<li><a href="http://imweb.io/topic/56d40adc0848801a4ba198ce" target="_blank" rel="external">不会Object.defineProperty你就out了</a></li>
<li><a href="https://addyosmani.com/blog/understanding-mvvm-a-guide-for-javascript-developers/" target="_blank" rel="external">Understanding MVVM - A Guide For JavaScript Developers</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-04-06-git安装和管理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/06/2016-04-06-git安装和管理/" class="article-date">
  	<time datetime="2016-04-06T14:36:18.552Z" itemprop="datePublished">2016-04-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="git和bug管理系统_安装和学习报告">git和bug管理系统 安装和学习报告</h3><h4 id="1-_git安装">1. git安装</h4><h5 id="1-1_在Linux上安装git">1.1 在Linux上安装git</h5><p>通过一条命令直接完成git的安装<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-<span class="keyword">get</span> install git</span><br></pre></td></tr></table></figure></p>
<h5 id="1-2_在windows上安装git">1.2 在windows上安装git</h5><p>msysgit是Windows版的Git，从<a href="http://msysgit.github.io/" target="_blank" rel="external">http://msysgit.github.io/</a>下载，然后按默认选项安装即可。</p>
<p>安装完成后，在开始菜单里找到“Git”-&gt;“Git Bash”，蹦出一个类似命令行窗口的东西，就说明Git安装成功！</p>
<p>在安装完成以后,还需要设置好配置,在命令行下输入<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global user<span class="class">.name</span> <span class="string">"Your Name"</span></span><br><span class="line">$ git config --global user<span class="class">.email</span> <span class="string">"email@example.com"</span></span><br></pre></td></tr></table></figure></p>
<p>因为Git是分布式版本控制系统，所以，每个机器都必须自报家门：你的名字和Email地址。</p>
<p><strong><code>git config</code> 中使用了 <code>--global</code> 参数,这表示你这台机器上所有的Git仓库都会使用这个配置，当然也可以对某个仓库指定不同的用户名和Email地址.</strong></p>
<p>[相关连接]<br><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137396287703354d8c6c01c904c7d9ff056ae23da865a000" target="_blank" rel="external">安装git - 廖雪峰的网站</a></p>
<h4 id="2-_git管理的概述和基本应用">2. git管理的概述和基本应用</h4><pre><code>为了我们之后更好地理解我们在git下的操作,我们会简单地介绍一下git能为我们做什么,我们怎么利用这些功能来管理我们的代码的。
</code></pre><p>git系统里，本地就是远程服务器的一个镜像，所有git里的分支，本地和远程都各有一份，这个需要明确，push的时候会把本地分支推送到服务器。 </p>
<p><img src="/home/ailin/图片/git/01.jpg" alt=""></p>
<p>每个客户端都有一个服务器端的镜像，这里可以在本地进行一切版本控制的操作，完成后推送到服务器端合并。</p>
<p><strong>————————上面讲的是远程和本地的关系，下面要讲的是在本地管理的比较重要的概念。————————-</strong></p>
<h5 id="工作区和暂存区">工作区和暂存区</h5><p><img src="/home/ailin/图片/git/02.jpg" alt=""></p>
<p>我们修改文件是在工作区，就是我们的工作目录，调用 <code>git add</code> 命令将其修改加入暂存区，没有进入版本库，当你觉得所有的东西都修改完后，可以调用 <code>git commit</code> 提交至本地的版本库。</p>
<p>这样，我们本地的版本库就会发生改变了。但是其他成员看不到你的修改的，所以我们就需要 <code>git push</code> 把本地的版本库推送至远程版本库中。这里也就会涉及到代码发生冲突的情况，当代码在推送到远程版本库时发现我们的本地代码和现在远程版本库中的代码发生了冲突， 那么这个时候就需要我们 <code>git pull</code> 之后看看哪里发生冲突，然后手动修改冲突的地方再 <code>add commit push</code> ，当然这中间还可能会有版本回退，删除等问题。</p>
<p>[相关连接]<br><a href="http://dlutwuwei.github.io/2014/05/21/git%E4%BD%BF%E7%94%A8%E6%A6%82%E8%BF%B0/" target="_blank" rel="external">git使用概述</a></p>
<h5 id="分支管理">分支管理</h5><pre><code>分支在实际中有什么用呢？
假设你准备开发一个新功能，但是需要两周才能完成，第一周你写了<span class="number">50</span><span class="comment">%的代码</span>
如果立刻提交，由于代码还没写完，不完整的代码库会导致别人不能干活了。
如果等代码全部写完再一次提交，又存在丢失每天进度的巨大风险。
现在有了分支，就不用怕了。
你创建了一个属于你自己的分支.别人看不到，还继续在原来的分支上正常工作，
而你在自己的分支上干活，想提交就提交，直到开发完毕后，再一次性合并到原来的分支上，
这样，既安全，又不影响别人工作。
</code></pre><p>我们在实际开发中应该要有有master，dev这些分支，我们在本地可以另外自己开各种分支处理bug或者开发功能等等，然后在确定推送到本地版本库以后再推送到dev开发分支去。</p>
<p>当在dev的推送中发生冲突的时候就和上面的冲突管理类似，通过git pull手动修改好冲突的地方然后再次推送就好了。</p>
<p>其中也有谈到我们对bug的处理，一般就是在本地开一个bug的分支处理好了以后再合并到原分支并且删除bug分支即可。同时我们也可以利用git的issue来记录bug处理等等。</p>
<p>利用分支，多人协作的工作模式通常是这样：</p>
<ol>
<li>首先，可以试图用git push origin branch-name推送自己的修改；</li>
<li>如果推送失败，则因为远程分支比你的本地更新，需要先用git pull试图合并；</li>
<li>如果合并有冲突，则解决冲突，并在本地提交；</li>
<li>没有冲突或者解决掉冲突后，再用git push origin branch-name推送就能成功！</li>
<li>如果git pull提示“no tracking information”，则说明本地分支和远程分支的链接关系没有创建，用命令git branch —set-upstream branch-name origin/branch-name。</li>
</ol>
<p>更多详情请戳链接。</p>
<p>[相关连接]</p>
<p><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001375840038939c291467cc7c747b1810aab2fb8863508000" target="_blank" rel="external">分支管理 - 廖雪峰的网站</a></p>
<p><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013760174128707b935b0be6fc4fc6ace66c4f15618f8d000" target="_blank" rel="external">多人协作 - 廖雪峰的网站</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-03-24-关于面试中一些有意思的题目简单整理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/24/2016-03-24-关于面试中一些有意思的题目简单整理/" class="article-date">
  	<time datetime="2016-03-23T16:00:00.000Z" itemprop="datePublished">2016-03-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/24/2016-03-24-关于面试中一些有意思的题目简单整理/">面试中遇到的一些有意思的问题整理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <pre><code>其实经历的面试不多，但是面试中有些问题很有继续挖掘的空间，所以我决定先挖掘一下，以便在以后的面试中可以不断装B。（ORZ我到底在说些什么）
</code></pre><h4 id="常规类问题：">常规类问题：</h4><ol>
<li><p>你知道闭包么？你知道内存泄露么？你知道怎么查出内存泄露么？<br> 最后一个问题简直了，很合理但是很考你到底有没有去试验过，但是我觉得平时的话不会真的去查内存泄露这个问题，大都只是知道闭包呀，互相引用呀导致内存泄露，都是概念性的。那到底是怎么查出内存泄露呢。</p>
<p> 因为电话里面没听清楚，面试官大概给出的思路是你在函数执行前后查看memory的情况，如果前后不一致就代表内存泄露。</p>
<p> OK。那我们就要先知道怎么查看memory。Chrome的F12中的profile选项中中heap profile<br> 具体请戳链接<br> <a href="http://www.ibm.com/developerworks/cn/web/wa-jsmemory/" target="_blank" rel="external">[了解 JavaScript 应用程序中的内存泄漏]</a><br> <a href="https://developer.chrome.com/devtools/docs/javascript-memory-profiling" target="_blank" rel="external">[Javascript Memory profile]</a><br> 里面都有比较详细的介绍了。</p>
<p> 关键词就是利用profile的take heap snap，然后用comparison对比不同时刻的内存中对象。</p>
<p> 在链接里面也提到一个技巧，但是链接中的GC采用的是利用是否有对象是否可达root对象的方法来判断是否是垃圾的策略（但是浏览器不是看一个对象是否被其他对象引用来判断这个对象是否是垃圾的么？），中间有一个distance表示该对象离root对象的距离，<strong>如果同一类型的对象的distance不一样，这个情况就值得我们去关注了</strong>。</p>
</li>
<li><p>readyState表示的状态<br> 这个可以说得上是问得超级细了。我只答出了3,4，前面的1,2都没答对，然后面试官给我指出了这个状态码其实和我们原生发起一个请求的过程有关的。</p>
 <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var req = new xmlHttpRequest();</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> <span class="keyword">do</span> something</span><br><span class="line"></span><br><span class="line">req.open(url);  <span class="regexp">//</span> 此步操作代表连接服务器，成功以后即我们的<span class="number">1</span>-&gt;与服务器建立了连接</span><br><span class="line">req.send();     <span class="regexp">//</span> 此步代表发送请求，成功以后即我们的<span class="number">2</span>-&gt;服务器已接收了我们的请求</span><br></pre></td></tr></table></figure>
<p> 然后3和4就不用说了，就是数据正在返回和数据已经全部返回。不过面试官也表示这个不用记得这么细。。。（那为什么要问ORZ，估计是为了刁难一下）</p>
</li>
<li><p>cookie和localStorage比较<br>面试官会问非常细的问题，比如cookie最大存储的空间是多少，最多存多少对键值，localStorage呢？他们的缺点是什么？</p>
<p>cookie最多是4k，localStorage是5m，cookie一般是在服务器那边设定过期时间，localStorage自己不手动清的话会永久保存，cookie的信息会在每次发出请求的时候附在http头，而localStorage是存在客户端，不直接参与通信，然后就是cookie的原生接口不够友好，localStorage的适当封装可以使它很友好（其中这里对于存对象会有小坑的，大家有兴趣的话可以去尝试一下，一面面试官问得特别猥琐，他直接就只是问“你用localStorage有没有遇到过什么坑呀？没遇到过？说明你接触不够多呀”，后来面完以后仔细想了一下才反应过来应该是指这个坑，一点提示都不给，问得这么含糊，肯定反应不过来啦，真是太不够意思了，噢扯远了）</p>
<p>回到正题，我觉得他们比较大的缺点主要是在于cookie过长的话，由于http每次都要带上他，导致请求大小变大（http包说：对不起你太重了我飞不动哈哈哈哈ORZ），而且cookie的小容量会有很大的限制。</p>
<p>这个问题也要我想起了之前在web security里面做cookie欺骗实验中一个问题，我登上JD，然后在console下去修改cookie，发现是修改不了的，但是！我记得之前我们用js写cookie的时候是可以做到document.cookie = “xx:aaa;”,同样是脚本，为什么就修改不了呢？难道有设定写什么特殊的属性？于是我带着问题又去…（先把这个问题留住，下回分解好了⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄）。</p>
</li>
</ol>
<h4 id="非常规类问题">非常规类问题</h4><ol>
<li><p>针对csrf攻击时，中间存在由于浏览器会对应域名找到它对应的cookie，附在非法请求的头来获得权限的现象，面试官提问“怎么阻止这样的访问？”<br> 一般都是说什么验证码呀，token什么之类的，但是面试官他还是不太满意，他说针对cookie的怎么阻止，就在这时面试官的电话就没电了。。。其实这个问题我还是不太会的，因为面试官当时的感觉是要阻止这个cookie附在其他网页的请求中？（我不太听得懂），后来我上网针对性地搜索了一下，觉得面试官可能是想要“双提交cookie”这样的方案。</p>
<p> “双提交cookie”是指不但http头里面有cookie，你的请求中也要带有cookie的信息。嗯，为什么要这样做呢？我们document.cookie只是<strong>document</strong>的，是当前页面下的cookie，当你在当前域名页面下要获取另外页面（即不同域名下）的cookie时，，实际这里也会存在一个跨域的请求（跨域是包括接口（port）的，同一个浏览器打开的不同的窗口实际都是新开的一个请求，即其实port都是不一样的，而同源策略是包含port在内的，即时同样是处在localhost下，所以这样就会存在跨域请求cookie的问题），因此这样我们是无法提取到那个cookie的信息出来的，就无法明文加入到我们的请求中，从而实现了阻止这类攻击。</p>
</li>
<li><p>一面的面试官还问了一个算法题，迄今都还不会ORZ。一个队列，只有进队出队的操作，它里面存的都是对象，对象中会有属性和值，现在给出了属性和对应的值，让你找出队列中的那个对象。<br> 到这里都很简单呀，遍历呀。<br> 面试官说：“现在增加条件，要求在O(1)时间复杂度下找到”<br> 瞬间gg。<br> 我：“不遍历怎么找哦？”<br> 面试官：“自己回去想咯，这题pass”<br> ORZ看来要去刷leetcode了</p>
</li>
<li><p>还有一个问题是有关dns解析的问题，应该是指一个域名对应了多个ip地址，做轮训，然后就可以并发发出请求，均衡负载了。其实我还不太懂面试官的问的问题的意思，但是他知道我没做过有关集群的东西就没有再继续问了。</p>
</li>
</ol>
<p>暂时就这么多，加油加油。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/面试/">面试</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-03-20-More-About-setTimeout-and-event-loop" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/20/2016-03-20-More-About-setTimeout-and-event-loop/" class="article-date">
  	<time datetime="2016-03-19T16:00:00.000Z" itemprop="datePublished">2016-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/20/2016-03-20-More-About-setTimeout-and-event-loop/">从setTimeout看event loop</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近发现如果不写博客的话,看资料的效率会降低…所以我要多记录一下才行了。<br>最近在知乎上面看到一个很好的问题和答案。<br><a href="https://www.zhihu.com/question/36972010" target="_blank" rel="external">Promise的队列与setTimeout的队列的有何关联</a><br>最高票的答案写得很好。我简单地做一个重点的记录。</p>
<p>题主的问题在于同时用setTimeout和promise的时候，谁先谁后的问题，以及就是promise的注册回调问题（同步还是异步），这些问题都集中到了event loop上面。</p>
<p><a href="http://www.w3.org/TR/html5/webappapis.html#event-loops" target="_blank" rel="external">w3c文档中event-loops介绍</a><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must <span class="operator"><span class="keyword">use</span> <span class="keyword">event</span> loops <span class="keyword">as</span> described <span class="keyword">in</span> this <span class="keyword">section</span>.</span><br><span class="line"></span><br><span class="line">An <span class="keyword">event</span> loop has one <span class="keyword">or</span> more task queues. A task queue <span class="keyword">is</span> an ordered list <span class="keyword">of</span> tasks, which <span class="keyword">are</span> algorithms that <span class="keyword">are</span> responsible <span class="keyword">for</span> such <span class="keyword">work</span> <span class="keyword">as</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">Events</span></span><br><span class="line">Asynchronously dispatching an <span class="keyword">Event</span> object <span class="keyword">at</span> a particular EventTarget object <span class="keyword">is</span> often done <span class="keyword">by</span> a dedicated task.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Not</span> <span class="keyword">all</span> <span class="keyword">events</span> <span class="keyword">are</span> dispatched <span class="keyword">using</span> the task queue, many <span class="keyword">are</span> dispatched synchronously during other tasks.</span><br><span class="line"></span><br><span class="line">Parsing</span><br><span class="line">The HTML parser tokenizing one <span class="keyword">or</span> more bytes, <span class="keyword">and</span> <span class="keyword">then</span> processing <span class="keyword">any</span> resulting tokens, <span class="keyword">is</span> typically a task.</span><br><span class="line"></span><br><span class="line">Callbacks</span><br><span class="line">Calling a callback asynchronously <span class="keyword">is</span> often done <span class="keyword">by</span> a dedicated task.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Using</span> a resource</span><br><span class="line"><span class="keyword">When</span> an algorithm fetches a resource, <span class="keyword">if</span> the fetching occurs asynchronously <span class="keyword">then</span> the processing <span class="keyword">of</span> the resource once <span class="keyword">some</span> <span class="keyword">or</span> <span class="keyword">all</span> <span class="keyword">of</span> the resource <span class="keyword">is</span> available <span class="keyword">is</span> performed <span class="keyword">by</span> a task.</span><br><span class="line"></span><br><span class="line">Reacting <span class="keyword">to</span> DOM manipulation</span><br><span class="line"><span class="keyword">Some</span> elements have tasks that <span class="keyword">trigger</span> <span class="keyword">in</span> response <span class="keyword">to</span> DOM manipulation, e.g. <span class="keyword">when</span> that element <span class="keyword">is</span> inserted <span class="keyword">into</span> the document.</span></span><br></pre></td></tr></table></figure></p>
<p>上面提到的是一个浏览器上下文就会有一个event loop,一个event loop至少对应一个浏览器上下文，如果一个event loop的所有浏览器上下文都没了，event loop也会消失。</p>
<p>一个event loop会有一个或多个任务队列，一个任务队列是有序的，里面包括的任务有：事件（点击等类似事件），解析（html parser解析数据），回调，获取资源（发送请求什么的），dom（插入dom等）</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">When <span class="operator">a</span> user agent is <span class="built_in">to</span> queue <span class="operator">a</span> task, <span class="keyword">it</span> must <span class="built_in">add</span> <span class="operator">the</span> given task <span class="built_in">to</span> <span class="constant">one</span> <span class="operator">of</span> <span class="operator">the</span> task queues <span class="operator">of</span> <span class="operator">the</span> relevant event loop.</span><br><span class="line"></span><br><span class="line">Each task is defined <span class="keyword">as</span> coming <span class="built_in">from</span> <span class="operator">a</span> specific task source. All <span class="operator">the</span> tasks <span class="built_in">from</span> <span class="constant">one</span> particular task source <span class="operator">and</span> destined <span class="built_in">to</span> <span class="operator">a</span> particular event loop (e.g. <span class="operator">the</span> callbacks generated <span class="keyword">by</span> timers <span class="operator">of</span> <span class="operator">a</span> Document, <span class="operator">the</span> events fired <span class="keyword">for</span> mouse movements over that Document, <span class="operator">the</span> tasks queued <span class="keyword">for</span> <span class="operator">the</span> parser <span class="operator">of</span> that Document) must always be added <span class="built_in">to</span> <span class="operator">the</span> same task queue, but tasks <span class="built_in">from</span> different task sources may be placed <span class="operator">in</span> different task queues.</span><br></pre></td></tr></table></figure>
<p>这里就是明白地指出每个任务都会被记录它来自哪个任务源，来自同一个的任务源的任务都会去同一个任务队列，但是这里没有说明同一个任务队列是否可以有不同的任务源，这些队列是有一定的优先级的。</p>
<p>知乎上的高票答案继续提到了promise的相关。<br>其中promise是microtask,setTimeout的是marcoTask，任务队列的顺序是去了<strong>一个</strong>marcoTask执行完毕，就把microTask中的所有任务都执行完。</p>
<ul>
<li><p>marcoTask: script(整体代码),setTimeout,setInterval,setImmediate,I/O,UI rendering</p>
</li>
<li><p>microTask: process.nextTick, Promises, Object.observe,MutationObserver</p>
</li>
</ul>
<p>所以promise会比setTimeout中的回调函数早执行。</p>
<p>综上，我对event loop的个人认识是：event loop是在执行完一个任务以后就从任务队列中取出下一个任务，这个任务队列实际上是有两条队列的，一条是macroTask队列，一条是microTask队列，取了一个macroTask执行完了以后任务将会是整个microTask队列里面的事件（你在microTask中的一个任务继续增加microTask，新增microTask也会在前面的microTask执行完了以后执行，所以不断新增microTask会带来marcoTask被阻塞的现象），将所有microTask事件都执行完了以后再去执行下一个marcoTask，如此往复。</p>
<p>其中marcoTask里面会分script(整体代码),setTimeout,setInterval,setImmediate,I/O,UI rendering，microTask里面会分process.nextTick, Promises, Object.observe,MutationObserver，队列里面也会有优先级的，具体的细节就不继续了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/浏览器原理/">浏览器原理</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-03-19-记录马克儿" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/19/2016-03-19-记录马克儿/" class="article-date">
  	<time datetime="2016-03-18T16:00:00.000Z" itemprop="datePublished">2016-03-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/19/2016-03-19-记录马克儿/">记录马克儿</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>试了一下做chrome扩展插件，下面分享一些链接</p>
<p>顺带学了一下es6，知道了一些基本的属性或者功能<br>这是在label的官网上的，比较简练。所以说做es6转换的还要有教人怎么写es6的义务哈哈哈哈。<br><a href="https://babeljs.io/docs/learn-es2015/" target="_blank" rel="external">[链接]:learn es2015</a></p>
<p>然后就是讲hadoop的map-reduce的一篇博文，讲得很详细的<br><a href="http://www.cnblogs.com/forfuture1978/archive/2010/11/14/1877086.html" target="_blank" rel="external">Hadoop学习总结之三:Map-Reduce入门</a><br>但是因为没去听课，所以我还是不太懂mapper和reducer开了多个task（即开了多个线程）的时候一些变量它到底是“全局的”还是“局部的”问题。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chrome-extension/">chrome extension</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/学习记录/">学习记录</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-03-12-说说有关setTimeout的那些事" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/12/2016-03-12-说说有关setTimeout的那些事/" class="article-date">
  	<time datetime="2016-03-11T16:00:00.000Z" itemprop="datePublished">2016-03-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/12/2016-03-12-说说有关setTimeout的那些事/">有关setTimeout的那些事</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在看源码的时候遇到这么个问题：setTimeout(func, 0)<br>有经验的人肯定知道这是异步呀，定了个计时器呀，但其实func只是被推到单线程（浏览器中就是js执行和UI渲染是在同一个进程中完成的）等待队列里面，设了个0秒后执行的定时器，然而由于我们线程中有正在执行中的代码，所以并不会马上执行func。这些都是基础部分，而我的问题是，那到底什么时候才执行呢。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    setTimeout(func1, <span class="number">0</span>);</span><br><span class="line">    B();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setTimeout(func2, <span class="number">0</span>);</span><br><span class="line">    C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码就是我的问题了</p>
<p><a href="http://imweb.io/topic/56642e21d91952db73b41f52" target="_blank" rel="external">[相关链接]</a><br><a href="http://ejohn.org/blog/how-javascript-timers-work/" target="_blank" rel="external">[相关链接]</a></p>
<p>相关链接中提到了“js block”，那到底“js block”到底到哪里才算是一个block呢<br>我做了相关实验<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"A"</span>);</span><br><span class="line">    setTimeout(<span class="string">"console.log('func1')"</span>, <span class="number">0</span>);</span><br><span class="line">    B();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"B"</span>);</span><br><span class="line">    setTimeout(<span class="string">"console.log('func2')"</span>, <span class="number">0</span>);</span><br><span class="line">    C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"C"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">A();</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// A</span></span><br><span class="line"><span class="comment">// B</span></span><br><span class="line"><span class="comment">// C</span></span><br><span class="line"><span class="comment">// func1</span></span><br><span class="line"><span class="comment">// func2</span></span><br></pre></td></tr></table></figure></p>
<p>猜想一，block是指当前函数的作用域<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"A"</span>);</span><br><span class="line">    setTimeout(func1, <span class="number">0</span>);</span><br><span class="line">    B();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; <span class="number">1000000</span>; i++);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"func1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"B"</span>);</span><br><span class="line">    setTimeout(func2, <span class="number">0</span>);</span><br><span class="line">    C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"func2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"C"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>假设block是指当前函数的作用域，那么我们在B函数结束的时候，定时器里面的func2就会执行了，然而并没有，我们还是会等到A函数中的大循环结束以后才执行B作用域中的定时器里面的函数。说明我们的假设不成立。</p>
<p>假设二，我们会等到call stack清空以后才执行计时器中的函数。由于我在做这个实验之前在看并实践一个小requirejs异步模块加载器的代码，上面这些实验代码都是放在一个模块里面做的，在ABC这些函数之外还有很多其他的匿名函数在call stack中，设置断点，发现确实是在call stack里面的代码都清空了以后才会执行我们计时器函数。说明我们的假设成立。</p>
<p>js block是指call stack中全部的js代码。</p>
<p>然后我去修改了一下定时器的计时时间，希望因此可以知道计时器和它排队的方式。<br>上面的代码的输出没什么疑问<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">fu<span class="label">nc1</span></span><br><span class="line">fu<span class="label">nc2</span></span><br></pre></td></tr></table></figure></p>
<p>func1和func2都是马上放到队列中，两者的时间都是定了0，func1先设置，根据”队列“这样的字眼，我们就知道应该是先进先出的顺序，因此func1先执行，func2后执行。</p>
<p>同样的如果把两者的时间设为2， 5， 10或100，结果也是一样的。</p>
<p>然后我们做出一个尝试，我们把func1的执行时间定在1ms后，func2的不变还是0，我们运行查看结果<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">fu<span class="label">nc1</span></span><br><span class="line">fu<span class="label">nc2</span></span><br></pre></td></tr></table></figure></p>
<p>仍然和之前的输出一样，然后我们把func1的执行时间定为2ms，func2改为1ms，总之就是要让他们的时间差保持为1ms<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">fu<span class="label">nc2</span></span><br><span class="line">fu<span class="label">nc1</span></span><br></pre></td></tr></table></figure></p>
<p>输出结果发生了改变，真是见鬼了。我们继续保持1ms的时间差，调不同的基数10,100，1000做实验，然后之后这些输出都是<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">fu<span class="label">nc2</span></span><br><span class="line">fu<span class="label">nc1</span></span><br></pre></td></tr></table></figure></p>
<p>之后的输出确实是符合我们想要的，func1等1000ms，func2等1001ms执行，虽然他们设定计时器的时间点不一样，但是由于程序运行的时间足够快，所以他们设定时间点的差会略小于1ms，但是应该是会大于0ms的。</p>
<p>为了验证这点，我们在他们设定定时器之间的这段时间插入一段很大的循环，使得他们设定计时器的时间差大于1ms<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"A"</span>);</span><br><span class="line">    setTimeout(func1, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// add loop</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; <span class="number">1000000</span>; i++);</span><br><span class="line">    B();</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"func1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"B"</span>);</span><br><span class="line">    setTimeout(func2, <span class="number">1</span>);</span><br><span class="line">    C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"func2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do somthing</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"C"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>果然输出和我们预想一样<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">fu<span class="label">nc1</span></span><br><span class="line">fu<span class="label">nc2</span></span><br></pre></td></tr></table></figure></p>
<p>(为了减少打字A/a:表示A函数在ams以后执行)<br>所以现在我们的疑问是集中在，为什么func1/1,func2/0和func1/2,func2/3,func1/11,func2/12这些的输出结果不一样，他们同样都是相差1ms呀</p>
<p>嗯。。然后我就去stack overflow去问了这个问题了，但是还没有人回答，等到有回答了再更ORZ。<br>//===============================<br>2016.03.19更新<br>stack overflow上面有人提出了这个问题在不同浏览器中的表现是不一样的，这说明应该和浏览器底层实现有关吧。之前在知乎上面有看到过有关setTimeout和底层事件处理的文章，之后再写一篇吧。</p>
<p>//===============================</p>
<p>对了这里顺便说一下setTimeout和setInterval的区别。<br>setTimeout去实现像setInterval这样的功能的时候的思路就是在回调函数再调用setTimeout，而setInterval就是一开始设置了就之后每隔一段时间去跑回调函数就好了。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something here</span></span><br><span class="line">        setTimeout(loop, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line">setInterval(doSomething, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></p>
<p>看上去两者好像没什么区别，但是就在我们刚刚讨论的时候就提到了浏览器中是单线程的，这里就会存在”事情太多了，定时器时间到了，但是前面的事情还没做好，还轮不到我去执行“这样的情景。在这样的情景中，setTimeout因为每次新的设置定时器都是在前一个定时器的回调函数触发了以后设置的，所以这个可以保证会以1， 2， 3这样的顺序进行。然而setInterval是不负责任的，它不管队列中是否还有没有执行的前面的函数，它一到时间就把这个回调函数推到队列中，又因为队列不允许有相同的setInterval的函数同时在一个队列中，所以假设1还没有执行，推了2进队列，那么2将会被abort，setInterval一到时间就会推3进去，不管死活，这样就可能会导致我们的程序出错了。</p>
<p>就个人而言还是比较喜欢setTimeout：p</p>
<p>近期目标：<br>看源码，小框架的实现，可以试下造下轮子？（jquery插件或者chrome插件）<br>（ife的高级任务：mvvm表格实现）</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/setTimeout/">setTimeout</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/定时器/">定时器</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2016-03-06-Jquery源码之jsonp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/06/2016-03-06-Jquery源码之jsonp/" class="article-date">
  	<time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished">2016-03-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/06/2016-03-06-Jquery源码之jsonp/">JQuery中的jsonp源码剖析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="问题背景">问题背景</h5><p>不久之前遇到过跨域问题，google以后知道这是由于<strong>同源策略</strong>导致的，我们要利用script，img类似等标签去跨域访问，同时还需要服务器后台的配合返回的js里面是包含我们想要的“回调函数”的调用。</p>
<h5 id="当时的解决方法">当时的解决方法</h5><p>直接使用jquery的ajax，在里面的dataType设置为jsonp就解决了这个问题</p>
<h5 id="问题延展">问题延展</h5><p>由于跨域问题十分常见，所以我想探究一下jquery里面是如何实现jsonp的，并且可以做到接口高度抽象的。</p>
<p>正式进入源码分析<br><a href="https://github.com/jquery/jquery/" target="_blank" rel="external">[源码地址]</a><br>一般我们是这么调用ajax的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$<span class="class">.ajax</span>(<span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">url</span>:<span class="value"> <span class="string">"http://"</span>+url,</span><br><span class="line">    type: <span class="string">'GET'</span>,</span><br><span class="line">    dataType: <span class="string">'JSONP'</span>,  // cross-orign</span><br><span class="line">    success: <span class="function">function</span>(data) &#123;</span><br><span class="line">        _this.<span class="function">setState</span>(&#123;bubbles: data&#125;)</span></span>;</span><br><span class="line">    &#125;</span>,</span><br><span class="line">    <span class="rule"><span class="attribute">error</span>:<span class="value"> <span class="function">function</span>(e) &#123;</span><br><span class="line">        console.<span class="function">log</span>(e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们要先找到ajax的入口，这是一段相当长的代码，我会跳出核心重要的地方出来<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 383 at ajax.js</span></span><br><span class="line">ajax: <span class="function"><span class="keyword">function</span><span class="params">( url, options )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If url is an object, simulate pre-1.5 signature</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> url === <span class="string">"object"</span> ) &#123;</span><br><span class="line">            options = url;</span><br><span class="line">            url = <span class="literal">undefined</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Force options to be an object</span></span><br><span class="line">        options = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">            Continue to be</span><br><span class="line">        *</span></span><br></pre></td></tr></table></figure></p>
<p>结合我们之前调用ajax的例子，我们可以看到我们传入的对应url的是一个对象，所以options将会变为我们传入的对象，而url会变为undefined。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">options</span> = <span class="keyword">options</span> || &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>jquery里面常见的赋值方法,为了确保值的类型，减少会有很多undefined的情况。</p>
<p>我们继续看<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 422</span></span><br><span class="line">    <span class="comment">// Create the final options object</span></span><br><span class="line">    s = jQuery.<span class="function"><span class="title">ajaxSetup</span><span class="params">( &#123;&#125;, options )</span></span></span><br></pre></td></tr></table></figure></p>
<p>这里出现了一个重要的函数ajaxSetup，它调用了options，返回了一个东西给s，这个s我们会在后面的代码中频繁地看到。</p>
<p>因此我们去看下ajaxSetup的具体实现<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a full fledged settings object into target</span></span><br><span class="line"><span class="comment">// with both ajaxSettings and settings fields.</span></span><br><span class="line"><span class="comment">// If target is omitted, writes into ajaxSettings.</span></span><br><span class="line">ajaxSetup: function( <span class="keyword">target</span>, settings ) &#123;</span><br><span class="line">    <span class="keyword">return</span> settings ?</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Building a settings object</span></span><br><span class="line">        ajaxExtend( ajaxExtend( <span class="keyword">target</span>, jQuery.ajaxSettings ), settings ) :</span><br><span class="line"></span><br><span class="line">        // Extending ajaxSettings</span><br><span class="line">        ajaxExtend( jQuery.ajaxSettings, <span class="keyword">target</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的target是我们传入的空对象{}，settings就是我们的options，这里又调用了ajaxExtend和ajaxSettings来新建一个settings对象。我们去看看这两个相关的代码。</p>
<p>来看看ajaxSettings的相关代码，真够长的，这些都是相当于默认的配置属性，有些用来设置请求头的属性等等。<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 299</span></span><br><span class="line">ajaxSettings: &#123;</span><br><span class="line">    url: location.href,</span><br><span class="line">    <span class="class"><span class="keyword">type</span>: "<span class="title">GET</span>",</span></span><br><span class="line">    isLocal: rlocalProtocol.test( location.protocol ),</span><br><span class="line">    <span class="keyword">global</span>: <span class="keyword">true</span>,</span><br><span class="line">    processData: <span class="keyword">true</span>,</span><br><span class="line">    async: <span class="keyword">true</span>,</span><br><span class="line">    contentType: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">    /*</span><br><span class="line">    timeout: <span class="number">0</span>,</span><br><span class="line">    data: <span class="keyword">null</span>,</span><br><span class="line">    dataType: <span class="keyword">null</span>,</span><br><span class="line">    username: <span class="keyword">null</span>,</span><br><span class="line">    password: <span class="keyword">null</span>,</span><br><span class="line">    cache: <span class="keyword">null</span>,</span><br><span class="line">    throws: <span class="keyword">false</span>,</span><br><span class="line">    traditional: <span class="keyword">false</span>,</span><br><span class="line">    headers: &#123;&#125;,</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    accepts: &#123;</span><br><span class="line">        <span class="string">"*"</span>: allTypes,</span><br><span class="line">        text: <span class="string">"text/plain"</span>,</span><br><span class="line">        html: <span class="string">"text/html"</span>,</span><br><span class="line">        xml: <span class="string">"application/xml, text/xml"</span>,</span><br><span class="line">        json: <span class="string">"application/json, text/javascript"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    contents: &#123;</span><br><span class="line">        xml: /\bxml\b/,</span><br><span class="line">        html: /\bhtml/,</span><br><span class="line">        json: /\bjson\b/</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    responseFields: &#123;</span><br><span class="line">        xml: <span class="string">"responseXML"</span>,</span><br><span class="line">        text: <span class="string">"responseText"</span>,</span><br><span class="line">        json: <span class="string">"responseJSON"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Data converters</span></span><br><span class="line">    <span class="comment">// Keys separate source (or catchall "*") and destination types with a single space</span></span><br><span class="line">    converters: &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert anything to text</span></span><br><span class="line">        <span class="string">"* text"</span>: String,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Text to html (true = no transformation)</span></span><br><span class="line">        <span class="string">"text html"</span>: <span class="keyword">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Evaluate text as a json expression</span></span><br><span class="line">        <span class="string">"text json"</span>: JSON.parse,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Parse text as xml</span></span><br><span class="line">        <span class="string">"text xml"</span>: jQuery.parseXML</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For options that shouldn't be deep extended:</span></span><br><span class="line">    <span class="comment">// you can add your own custom options here if</span></span><br><span class="line">    <span class="comment">// and when you create one that shouldn't be</span></span><br><span class="line">    <span class="comment">// deep extended (see ajaxExtend)</span></span><br><span class="line">    flatOptions: &#123;</span><br><span class="line">        url: <span class="keyword">true</span>,</span><br><span class="line">        context: <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是ajaxExtend的实现代码<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A special extend for ajax options</span></span><br><span class="line"><span class="comment">// that takes "flat" options (not to be deep extended)</span></span><br><span class="line"><span class="comment">// Fixes #9887</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxExtend</span><span class="params">( target, src )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key, deep,</span><br><span class="line">        flatOptions = jQuery.ajaxSettings.flatOptions || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( key <span class="keyword">in</span> src ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( src[ key ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">            ( flatOptions[ key ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ key ] = src[ key ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">        jQuery.extend( <span class="literal">true</span>, target, deep );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们再看看我们之前找到的ajaxSetup代码<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a full fledged settings object into target</span></span><br><span class="line"><span class="comment">// with both ajaxSettings and settings fields.</span></span><br><span class="line"><span class="comment">// If target is omitted, writes into ajaxSettings.</span></span><br><span class="line">ajaxSetup: function( <span class="keyword">target</span>, settings ) &#123;</span><br><span class="line">    <span class="keyword">return</span> settings ?</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Building a settings object</span></span><br><span class="line">        ajaxExtend( ajaxExtend( <span class="keyword">target</span>, jQuery.ajaxSettings ), settings ) :</span><br><span class="line"></span><br><span class="line">        // Extending ajaxSettings</span><br><span class="line">        ajaxExtend( jQuery.ajaxSettings, <span class="keyword">target</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们知道了jQueryajaxSettings就是一堆的对象属性而已，因此我们把重点放在ajaxExtend上</p>
<p>（为了思路可以更清晰，可能同一个函数的代码会出现多次，比较方便看）<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A special extend for ajax options</span></span><br><span class="line"><span class="comment">// that takes "flat" options (not to be deep extended)</span></span><br><span class="line"><span class="comment">// Fixes #9887</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxExtend</span><span class="params">( target, src )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key, deep,</span><br><span class="line">        flatOptions = jQuery.ajaxSettings.flatOptions || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( key <span class="keyword">in</span> src ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( src[ key ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">            ( flatOptions[ key ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ key ] = src[ key ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">        jQuery.extend( <span class="literal">true</span>, target, deep );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前我们在ajaxSetup里面第一个调用ajaxExtend的时候是<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ajaxExtend</span><span class="params">( target, jQuery.ajaxSettings )</span></span>；</span><br></pre></td></tr></table></figure></p>
<p>很明显，就是想把ajaxSettings的属性都扩展到target（现在还是{}）上面去。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend</span></span><br><span class="line">flatOptions = jQuery.ajaxSettings.flatOptions <span class="string">|| &#123;&#125;;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">ajaxSettings</span>: &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        a lot of stuff here</span><br><span class="line">    */</span></span><br><span class="line">    <span class="tag">flatOptions</span>: &#123;</span><br><span class="line">        <span class="attribute">url</span>: true,</span><br><span class="line">        <span class="attribute">context</span>: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们传入的<code>ajaxExtend( target, src )</code>中的target是{}，src此时是ajaxSettings<br>我们要返回去看ajaxSettings，可以看到里面除了url的键，但我没看到有context这个键，对此我也很是疑惑，还有很多其他的键，这是flatOptions里面没有的属性。<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend function</span></span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">key</span> in src ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( src[ <span class="variable">key</span> ] !== undefined ) &#123;</span><br><span class="line">        ( flatOptions[ <span class="variable">key</span> ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ <span class="variable">key</span> ] = src[ <span class="variable">key</span> ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这时候我们认真地想一下，就可以发现除了url和context属性之外的属性都会被赋值到deep上面，target即开始的空对象{}就只有url和context键和键值赋值上去。</p>
<p>即经过第一个ajaxExtend函数调用之后，首先我们的target, deep变成了<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">target:</span> &#123;</span><br><span class="line"><span class="label">    url:</span> location.href,</span><br><span class="line"><span class="label">    context:</span> undefined,  <span class="comment">// smg？！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">deep :</span> &#123;</span><br><span class="line">    ajaxSettings里除了url和context的所有属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后deep<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend</span></span><br><span class="line"><span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">    jQuery.extend( <span class="keyword">true</span>, <span class="keyword">target</span>, deep );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>deep看来是又被加到target那里，所以现在的target变成了<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">target</span>: &#123;</span><br><span class="line">    <span class="attribute">url</span>: location.href,</span><br><span class="line">    <span class="attribute">context</span>: undefined,  <span class="comment">// smg？！</span></span><br><span class="line">    所有其他的ajaxSettings里面的属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后target返回，再次调用ajaxExtend<br><code>ajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings )</code>，这时是将刚刚返回的target和settings（即我们最开始传进去ajax的那个对象）放到ajaxExtend里面去调用。</p>
<p>捋一捋，现在target和settings是什么东西<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">target: &#123;</span><br><span class="line">    url: location.href,</span><br><span class="line">    context: <span class="literal">undefined</span>,  <span class="comment">// smg？！</span></span><br><span class="line">    所有其他的ajaxSettings里面的属性</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们自己调用ajax的时候传入的对象</span></span><br><span class="line">settings: &#123;</span><br><span class="line">    url: <span class="string">"http://"</span>+url,</span><br><span class="line">    type: <span class="string">'GET'</span>,</span><br><span class="line">    dataType: <span class="string">'JSONP'</span>,  <span class="comment">// cross-orign</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">        _this.setState(&#123;bubbles: data&#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个作为形参调用ajaxExtend，分析手法和上述类似，这里就同理了。<br>返回的最终对象target就是包含了所有ajaxSettings属性在内，键值之后被我们自己传入的对象属性覆盖更新，context为undefined的对象。</p>
<p>这里面我们就知道了前面的对象s就是这个最终对象target了，难怪要命名成s，其实说白了就是一个有很多属性在里面的对象，settings而已。</p>
<p>因此我们又回到了ajax这个主函数里面的第422行之后的代码上。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Callbacks <span class="keyword">context</span></span><br><span class="line">callbackContext = s.<span class="keyword">context</span> || s,</span><br><span class="line"></span><br><span class="line">// <span class="keyword">Context</span> <span class="keyword">for</span> global events <span class="keyword">is</span> callbackContext <span class="keyword">if</span> it <span class="keyword">is</span> a DOM node <span class="keyword">or</span> jQuery collection</span><br><span class="line">globalEventContext = s.<span class="keyword">context</span> &amp;&amp;</span><br><span class="line">    ( callbackContext.nodeType || callbackContext.jquery ) ?</span><br><span class="line">        jQuery( callbackContext ) :</span><br><span class="line">        jQuery.event,</span><br></pre></td></tr></table></figure></p>
<p>s.context是undefined的，所以callbackContent变成s，callbackContent里面也没有nodeType和jquery，因此，globalEventContext变成了jQuery.event.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jQuery.event = &#123;</span><br><span class="line">    add: <span class="function"><span class="keyword">function</span> <span class="params">( elem, types, handler, data, selector )</span> </span>&#123;</span><br><span class="line">    dispatch: <span class="function"><span class="keyword">function</span> <span class="params">( event )</span> </span>&#123;</span><br><span class="line">    fix: <span class="function"><span class="keyword">function</span> <span class="params">( event )</span> </span>&#123;</span><br><span class="line">    fixHooks: <span class="built_in">Object</span></span><br><span class="line">    global: <span class="built_in">Object</span></span><br><span class="line">    handlers: <span class="function"><span class="keyword">function</span> <span class="params">( event, handlers )</span> </span>&#123;</span><br><span class="line">    keyHooks: <span class="built_in">Object</span></span><br><span class="line">    mouseHooks: <span class="built_in">Object</span></span><br><span class="line">    props: <span class="built_in">Array</span>[<span class="number">14</span>]</span><br><span class="line">    remove: <span class="function"><span class="keyword">function</span> <span class="params">( elem, types, handler, selector, mappedTypes )</span> </span>&#123;</span><br><span class="line">    simulate: <span class="function"><span class="keyword">function</span> <span class="params">( type, elem, event )</span> </span>&#123;</span><br><span class="line">    special: <span class="built_in">Object</span></span><br><span class="line">    trigger: <span class="function"><span class="keyword">function</span> <span class="params">( event, data, elem, onlyHandlers )</span> </span>&#123;</span><br><span class="line">    __proto__: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个是我用浏览器打开设断点以后看到event的具体属性，为了解说可以推进得更快。</p>
<p>我们继续<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 433</span></span><br><span class="line"><span class="comment">// Deferreds</span></span><br><span class="line">deferred = jQuery.Deferred(),</span><br><span class="line">completeDeferred = jQuery.Callbacks( <span class="string">"once memory"</span> ),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Status-dependent callbacks</span></span><br><span class="line">statusCode = s.statusCode <span class="string">|| &#123;&#125;,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Headers (they are sent all at once)</span></span><br><span class="line">requestHeaders = &#123;&#125;,</span><br><span class="line">requestHeadersNames = &#123;&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default abort message</span></span><br><span class="line">strAbort = <span class="string">"canceled"</span>,</span><br></pre></td></tr></table></figure></p>
<p>这里都是一些相关的设置，暂时还不太重要，我们可以快速跳过。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 448</span></span><br><span class="line"><span class="comment">// Fake xhr</span></span><br><span class="line">jqXHR = &#123;</span><br><span class="line">    readyState: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Builds headers hashtable if needed</span></span><br><span class="line">    getResponseHeader: <span class="function"><span class="keyword">function</span><span class="params">( key )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> match;</span><br><span class="line">        <span class="keyword">if</span> ( completed ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !responseHeaders ) &#123;</span><br><span class="line">                responseHeaders = &#123;&#125;;</span><br><span class="line">                <span class="keyword">while</span> ( ( match = rheaders.exec( responseHeadersString ) ) ) &#123;</span><br><span class="line">                    responseHeaders[ match[ <span class="number">1</span> ].toLowerCase() ] = match[ <span class="number">2</span> ];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            match = responseHeaders[ key.toLowerCase() ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match == <span class="literal">null</span> ? <span class="literal">null</span> : match;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Raw string</span></span><br><span class="line">    getAllResponseHeaders: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> completed ? responseHeadersString : <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Caches the header</span></span><br><span class="line">    setRequestHeader: <span class="function"><span class="keyword">function</span><span class="params">( name, value )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( completed == <span class="literal">null</span> ) &#123;</span><br><span class="line">            name = requestHeadersNames[ name.toLowerCase() ] =</span><br><span class="line">                requestHeadersNames[ name.toLowerCase() ] || name;</span><br><span class="line">            requestHeaders[ name ] = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Overrides response content-type header</span></span><br><span class="line">    overrideMimeType: <span class="function"><span class="keyword">function</span><span class="params">( type )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( completed == <span class="literal">null</span> ) &#123;</span><br><span class="line">            s.mimeType = type;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status-dependent callbacks</span></span><br><span class="line">    statusCode: <span class="function"><span class="keyword">function</span><span class="params">( map )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> code;</span><br><span class="line">        <span class="keyword">if</span> ( map ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( completed ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Execute the appropriate callbacks</span></span><br><span class="line">                jqXHR.always( map[ jqXHR.status ] );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Lazy-add the new callbacks in a way that preserves old ones</span></span><br><span class="line">                <span class="keyword">for</span> ( code <span class="keyword">in</span> map ) &#123;</span><br><span class="line">                    statusCode[ code ] = [ statusCode[ code ], map[ code ] ];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cancel the request</span></span><br><span class="line">    abort: <span class="function"><span class="keyword">function</span><span class="params">( statusText )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> finalText = statusText || strAbort;</span><br><span class="line">        <span class="keyword">if</span> ( transport ) &#123;</span><br><span class="line">            transport.abort( finalText );</span><br><span class="line">        &#125;</span><br><span class="line">        done( <span class="number">0</span>, finalText );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 认真观察这段代码发现有几个属性是比较关键的，一个是completed，一个是transport，都是这些函数的if里面判断的属性。我们到前面去看看这两个属性。<br> <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// line <span class="number">410</span></span><br><span class="line">// Request <span class="keyword">state</span> (becomes false upon send and true upon completion)</span><br><span class="line">    completed,</span><br><span class="line"></span><br><span class="line">// transport没有注释，所以暂时未知，可以猜测是</span><br></pre></td></tr></table></figure></p>
<p>上面jqXHR的对象里面的属性命名大概就是他们的作用了，我们知道了这应该是控制请求的头呀等等的属性和收到请求以后的一些操作函数。</p>
<p>我们继续ajax部分的<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 520</span></span><br><span class="line"><span class="comment">// Attach deferreds</span></span><br><span class="line">deferred.promise<span class="comment">( jqXHR )</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们看到了一个promise，我们对这种名字的函数应该要比较敏感（node里面也有promise的函数），我们可以深入去了解一下这个函数。</p>
<p>那我们就必须要先看deferred这个对象。这是前面的一个对象。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 434</span></span><br><span class="line"><span class="comment">// Deferreds</span></span><br><span class="line">deferred = jQuery.<span class="function"><span class="title">Deferred</span><span class="params">()</span></span>,</span><br><span class="line">completeDeferred = jQuery.<span class="function"><span class="title">Callbacks</span><span class="params">( <span class="string">"once memory"</span> )</span></span>,</span><br></pre></td></tr></table></figure></p>
<p>同样的我也是在浏览器里面去查看这个对象的属性<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">deferred = &#123;</span><br><span class="line">    always: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    done: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    fail: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    notify: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    notifyWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    pipe: <span class="function"><span class="keyword">function</span> <span class="params">( <span class="comment">/* fnDone, fnFail, fnProgress */</span> )</span> </span>&#123;</span><br><span class="line">    progress: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    promise: <span class="function"><span class="keyword">function</span> <span class="params">( obj )</span> </span>&#123;</span><br><span class="line">    reject: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    rejectWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    resolve: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    resolveWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    state: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    then: <span class="function"><span class="keyword">function</span> <span class="params">( <span class="comment">/* fnDone, fnFail, fnProgress */</span> )</span> </span>&#123;</span><br><span class="line">    __proto__: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们有时间的话再去看看promise（由于不够时间的原因），我们大概知道promise就要有异步的操作，对应这里的话就应该是异步发出请求吧。</p>
<p>好，我们继续ajax的主要函数部分。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// <span class="type">Add</span> protocol <span class="keyword">if</span> <span class="keyword">not</span> provided (prefilters might expect it)</span><br><span class="line">// <span class="type">Handle</span> falsy url <span class="keyword">in</span> the settings <span class="keyword">object</span> (<span class="comment">#10093: consistency with old signature)</span></span><br><span class="line">// <span class="type">We</span> also use the url parameter <span class="keyword">if</span> available</span><br><span class="line">s.url = ( ( url || s.url || location.href ) + <span class="string">""</span> )</span><br><span class="line">    .replace( rprotocol, location.protocol + <span class="string">"//"</span> );</span><br><span class="line"></span><br><span class="line">// <span class="type">Alias</span> <span class="keyword">method</span> option to <span class="keyword">type</span> <span class="keyword">as</span> per ticket <span class="comment">#12004</span></span><br><span class="line">s.<span class="keyword">type</span> = options.<span class="keyword">method</span> || options.<span class="keyword">type</span> || s.<span class="keyword">method</span> || s.<span class="keyword">type</span>;</span><br><span class="line"></span><br><span class="line">// <span class="type">Extract</span> dataTypes list</span><br><span class="line">s.dataTypes = jQuery.trim( s.dataType || <span class="string">"*"</span> ).toLowerCase().match( rnotwhite ) || [ <span class="string">""</span> ];</span><br></pre></td></tr></table></figure></p>
<p>设置请求的url，类型，传送的数据类型。（注意：我们可是jsonp）</p>
<p>接着<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A cross-domain request is in order when the origin doesn't match the current origin.</span></span><br><span class="line"><span class="keyword">if</span> ( s.crossDomain == <span class="keyword">null</span> ) &#123;</span><br><span class="line">    urlAnchor = <span class="built_in">document</span>.createElement( <span class="string">"a"</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Support: IE8-11+</span></span><br><span class="line">    <span class="comment">// IE throws exception if url is malformed, e.g. http://example.com:80x/</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        urlAnchor.href = s.url;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Support: IE8-11+</span></span><br><span class="line">        <span class="comment">// Anchor's host property isn't correctly set when s.url is relative</span></span><br><span class="line">        urlAnchor.href = urlAnchor.href;</span><br><span class="line">        s.crossDomain = originAnchor.protocol + <span class="string">"//"</span> + originAnchor.host !==</span><br><span class="line">            urlAnchor.protocol + <span class="string">"//"</span> + urlAnchor.host;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( e ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is an error parsing the URL, assume it is crossDomain,</span></span><br><span class="line">        <span class="comment">// it can be rejected by the transport if it is invalid</span></span><br><span class="line">        s.crossDomain = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里s.crossDomain是undefined，但是<code>s.crossDomain == null</code>返回的是true<br>在这段代码中，实际作用是<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s.crossDomain = originAnchor.protocol + <span class="string">"//"</span> + originAnchor.<span class="keyword">host</span> !==</span><br><span class="line">            urlAnchor.protocol + <span class="string">"//"</span> + urlAnchor.<span class="keyword">host</span>;</span><br></pre></td></tr></table></figure></p>
<p>判断是否有跨域行为</p>
<p>继续ajax主函数里面的代码<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Convert data if not already a string</span></span><br><span class="line"><span class="keyword">if</span> ( s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">&amp;&amp;</span> s<span class="built_in">.</span>processData <span class="subst">&amp;&amp;</span> typeof s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">!==</span> <span class="string">"string"</span> ) &#123;</span><br><span class="line">    s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">=</span> jQuery<span class="built_in">.</span>param( s<span class="built_in">.</span><span class="built_in">data</span>, s<span class="built_in">.</span>traditional );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将传输的数据全都转换为string</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure>
<p><code>inspectPrefilterOrTransports</code>这是ajax里面重要的函数</p>
<p>我们去认真地看一下这个函数的实现代码，再结合我们调用的参数<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>prefilters是外部函数的变量，开始为{}（按理说是空对象的，但是我在浏览器中观察的时候发现是有json，jsonp和script这些属性的，我开始的时候也觉得很迷惑），但是在我们调用ajax之前，实际我们已经调用了ajaxSetup, ajaxPrefilter这些函数，这是在jsonp.js里面调用的，是在js文件加载的时候就调用的，这也算是一个挺重要的小插曲，也会影响到我们后面的分析，所以我们还是要去看一下jsonp相关的代码。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default jsonp settings</span></span><br><span class="line">jQuery.ajaxSetup( &#123;</span><br><span class="line">    jsonp: <span class="string">"callback"</span>,</span><br><span class="line">    jsonpCallback: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">callback</span> = oldCallbacks.pop() || ( jQuery.expando + <span class="string">"_"</span> + ( nonce++ ) );</span><br><span class="line">        <span class="keyword">this</span>[ <span class="keyword">callback</span> ] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect, normalize options and install callbacks for jsonp requests</span></span><br><span class="line">jQuery.ajaxPrefilter( <span class="string">"json jsonp"</span>, <span class="function"><span class="keyword">function</span><span class="params">( s, originalSettings, jqXHR )</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        a lot of stuff here</span><br><span class="line">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在开始的时候就把jsonp和jsonCallback这两个属性加载我们的s那里去了，如果你还记得我们前面的分析过程的话，而ajaxPrefilter<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ajax.js line 379</span></span><br><span class="line">ajaxPrefilter: addToPrefiltersOrTransports( prefilters )</span><br><span class="line"></span><br><span class="line"><span class="comment">// ajax.js line 53</span></span><br><span class="line"><span class="comment">// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addToPrefiltersOrTransports</span><span class="params">( structure )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dataTypeExpression is optional and defaults to "*"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">( dataTypeExpression, func )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeExpression !== <span class="string">"string"</span> ) &#123;</span><br><span class="line">            func = dataTypeExpression;</span><br><span class="line">            dataTypeExpression = <span class="string">"*"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dataType,</span><br><span class="line">            i = <span class="number">0</span>,</span><br><span class="line">            dataTypes = dataTypeExpression.toLowerCase().match( rnotwhite ) || [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( jQuery.isFunction( func ) ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// For each dataType in the dataTypeExpression</span></span><br><span class="line">            <span class="keyword">while</span> ( ( dataType = dataTypes[ i++ ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Prepend if requested</span></span><br><span class="line">                <span class="keyword">if</span> ( dataType[ <span class="number">0</span> ] === <span class="string">"+"</span> ) &#123;</span><br><span class="line">                    dataType = dataType.slice( <span class="number">1</span> ) || <span class="string">"*"</span>;</span><br><span class="line">                    ( structure[ dataType ] = structure[ dataType ] || [] ).unshift( func );</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Otherwise append</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ( structure[ dataType ] = structure[ dataType ] || [] ).push( func );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单说来就是structure作为一个对象，这里就是我们的prefilters，原本是{}空对象，然后将dataTypeExpression，即我们这里的“json jsonp”用正则提取出所有的类型，然后当做键，键值是数组，把func，即跟在“json jsonp”传入的长长的匿名函数，推入到键值数组中。</p>
<p>我们基本知道了jsonp那里发生了什么事，我们再回到ajax.js，我们刚刚讲到<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>prefilters这个时候是一个有json，jsonp属性的对象，s是settings，options是我们传入的对象，jqXHR是我们要发的请求。</p>
<p><code>inspectPrefiltersOrTransports</code>函数实现<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Base inspection function for prefilters and transports</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inspectPrefiltersOrTransports</span><span class="params">( structure, options, originalOptions, jqXHR )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> inspected = &#123;&#125;,</span><br><span class="line">        seekingTransport = ( structure === transports );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> selected;</span><br><span class="line">        inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">        jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">            <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">                !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">                options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">                inspect( dataTypeOrTransport );</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">                <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; );</span><br><span class="line">        <span class="keyword">return</span> selected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inspect( options.dataTypes[ <span class="number">0</span> ] ) || !inspected[ <span class="string">"*"</span> ] &amp;&amp; inspect( <span class="string">"*"</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>options是总的settings，里面的dataTypes是经过我们自己传进去的对象更新过的，dataTypes此时只有jsonp的属性，即我们inspect（“jsonp”）这样子。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selected;</span><br><span class="line">    inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">    jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">            !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">            options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">            inspect( dataTypeOrTransport );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">            <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看看这个函数<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> dataTypeOrTransport</span> = prefilterOrFactory( options, originalOptions, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>在这里的<code>prefilterOrFactory</code>是指在jsonp.js传入的那个匿名函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span><span class="params">( s, originalSettings, jqXHR )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> callbackName, overwritten, responseContainer,</span><br><span class="line">        jsonProp = s.jsonp !== <span class="literal">false</span> &amp;&amp; ( rjsonp.test( s.url ) ?</span><br><span class="line">            <span class="string">"url"</span> :</span><br><span class="line">            <span class="keyword">typeof</span> s.data === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">                ( s.contentType || <span class="string">""</span> )</span><br><span class="line">                    .indexOf( <span class="string">"application/x-www-form-urlencoded"</span> ) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">                rjsonp.test( s.data ) &amp;&amp; <span class="string">"data"</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle iff the expected data type is "jsonp" or we have a parameter to set</span></span><br><span class="line">    <span class="keyword">if</span> ( jsonProp || s.dataTypes[ <span class="number">0</span> ] === <span class="string">"jsonp"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get callback name, remembering preexisting value associated with it</span></span><br><span class="line">        callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?</span><br><span class="line">            s.jsonpCallback() :</span><br><span class="line">            s.jsonpCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Insert callback into url or form data</span></span><br><span class="line">        <span class="keyword">if</span> ( jsonProp ) &#123;</span><br><span class="line">            s[ jsonProp ] = s[ jsonProp ].replace( rjsonp, <span class="string">"$1"</span> + callbackName );</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( s.jsonp !== <span class="literal">false</span> ) &#123;</span><br><span class="line">            s.url += ( rquery.test( s.url ) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span> ) + s.jsonp + <span class="string">"="</span> + callbackName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use data converter to retrieve json after script execution</span></span><br><span class="line">        s.converters[ <span class="string">"script json"</span> ] = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ( !responseContainer ) &#123;</span><br><span class="line">                jQuery.error( callbackName + <span class="string">" was not called"</span> );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> responseContainer[ <span class="number">0</span> ];</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Force json dataType</span></span><br><span class="line">        s.dataTypes[ <span class="number">0</span> ] = <span class="string">"json"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Install callback</span></span><br><span class="line">        overwritten = <span class="built_in">window</span>[ callbackName ];</span><br><span class="line">        <span class="built_in">window</span>[ callbackName ] = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            responseContainer = <span class="built_in">arguments</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean-up function (fires after converters)</span></span><br><span class="line">        jqXHR.always( <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If previous value didn't exist - remove it</span></span><br><span class="line">            <span class="keyword">if</span> ( overwritten === <span class="literal">undefined</span> ) &#123;</span><br><span class="line">                jQuery( <span class="built_in">window</span> ).removeProp( callbackName );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Otherwise restore preexisting value</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">window</span>[ callbackName ] = overwritten;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Save back as free</span></span><br><span class="line">            <span class="keyword">if</span> ( s[ callbackName ] ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure that re-using the options doesn't screw things around</span></span><br><span class="line">                s.jsonpCallback = originalSettings.jsonpCallback;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Save the callback name for future use</span></span><br><span class="line">                oldCallbacks.push( callbackName );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call if it was a function and we have a response</span></span><br><span class="line">            <span class="keyword">if</span> ( responseContainer &amp;&amp; jQuery.isFunction( overwritten ) ) &#123;</span><br><span class="line">                overwritten( responseContainer[ <span class="number">0</span> ] );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            responseContainer = overwritten = <span class="literal">undefined</span>;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegate to script</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"script"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是判断我们自定义的属性是不是有jsonp<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle iff the expected data type is "jsonp" or we have a parameter to set</span></span><br><span class="line"><span class="keyword">if</span> ( jsonProp || s.dataTypes[ <span class="number">0</span> ] === <span class="string">"jsonp"</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get callback name, remembering preexisting value associated with it</span></span><br><span class="line">    callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?</span><br><span class="line">        s.jsonpCallback() :</span><br><span class="line">        s.jsonpCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">            to be continued</span><br><span class="line">        */</span></span><br></pre></td></tr></table></figure></p>
<p><code>s.jsonpCallback</code>是我们在jsonp.js里面传入的<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jsonpCallback: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">callback</span> = oldCallbacks.pop() || ( jQuery.expando + <span class="string">"_"</span> + ( nonce++ ) );</span><br><span class="line">    <span class="keyword">this</span>[ <span class="keyword">callback</span> ] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">callback</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际是把我们传入的回调函数返回出来，否则就返回一串随机数，像<code>jQuery22105127492309547961_1457270695408</code>这样的玩意</p>
<p>然后就到最关键的部分了<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// <span class="constant">Insert</span> callback into url <span class="keyword">or</span> form data</span><br><span class="line"><span class="keyword">if</span> ( jsonProp <span class="keyword">) &#123;</span></span><br><span class="line">    s[ jsonProp ] = s[ jsonProp ].<span class="literal">replace</span>( rjsonp, <span class="string">"$1"</span> + callbackName );</span><br><span class="line"><span class="keyword">&#125;</span> <span class="keyword">else</span> <span class="keyword">if</span> ( s.jsonp !== <span class="keyword">false</span> <span class="keyword">) &#123;</span></span><br><span class="line">    s.url += ( rquery.test( s.url ) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span> ) + s.jsonp + <span class="string">"="</span> + callbackName;</span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>s.url在这里会变成像这样的<code>https://github.com/dengal3?callback=jQuery22105127492309547961_1457270695408</code>类似的玩意，这是因为我没有传callback函数，所以才会有这么一堆随机数的，但是关键的是这里产生了一个“？callback=”这样的玩意。</p>
<p>接着看jsonp.js的代码<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 57</span></span><br><span class="line"><span class="comment">// Force json dataType</span></span><br><span class="line">s.dataTypes[ <span class="number">0</span> ] = <span class="string">"json"</span>;</span><br></pre></td></tr></table></figure></p>
<p>这里强制把json改回来，传入的匿名函数返回的是“script”<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selected;</span><br><span class="line">    inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">    jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">            !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">            options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">            inspect( dataTypeOrTransport );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">            <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即这里的dataTypeOrTransport是“script”，然后<code>options.dataTypes.unshift( dataTypeOrTransport );</code>会把dataTypes变为{“script”， “json”}，“json”刚刚是被强制加上去的。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inspect<span class="list">( <span class="keyword">dataTypeOrTransport</span> )</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>structure[“script”]此时是在另一个ajaxSetup里面配置好的（在script.js里面）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Install script dataType</span></span><br><span class="line">jQuery.ajaxSetup( &#123;</span><br><span class="line">    accepts: &#123;</span><br><span class="line">        script: <span class="string">"text/javascript, application/javascript, "</span> +</span><br><span class="line">            <span class="string">"application/ecmascript, application/x-ecmascript"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    contents: &#123;</span><br><span class="line">        script: <span class="regexp">/\b(?:java|ecma)script\b/</span></span><br><span class="line">    &#125;,</span><br><span class="line">    converters: &#123;</span><br><span class="line">        <span class="string">"text script"</span>: <span class="function"><span class="keyword">function</span><span class="params">( text )</span> </span>&#123;</span><br><span class="line">            jQuery.globalEval( text );</span><br><span class="line">            <span class="keyword">return</span> text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle cache's special case and crossDomain</span></span><br><span class="line">jQuery.ajaxPrefilter( <span class="string">"script"</span>, <span class="function"><span class="keyword">function</span><span class="params">( s )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( s.cache === <span class="literal">undefined</span> ) &#123;</span><br><span class="line">        s.cache = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( s.crossDomain ) &#123;</span><br><span class="line">        s.type = <span class="string">"GET"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure></p>
<p>这里的ajaxPrefilter中的匿名函数就是用于crossDomain，跨域用的。</p>
<p>待续<br>我感觉还是没写好，之后再修改。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jquery/">Jquery</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jsonp/">jsonp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码剖析/">源码剖析</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-2015-7-24-note" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/07/24/2015-7-24-note/" class="article-date">
  	<time datetime="2015-07-24T01:49:04.000Z" itemprop="datePublished">2015-07-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/24/2015-7-24-note/">2015-7-24 note</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="dom">dom</h3><p><a href="http://www.imooc.com/learn/138" target="_blank" rel="external">dom事件流 慕课</a></p>
<ol>
<li>事件流: 描述的是从页面中接受事件的顺序(ie事件冒泡(从最内到最外),事件捕获(从内到外))</li>
<li>事件处理程序:<ol>
<li>html处理程序(比如onclick放在html中)</li>
<li>dom0级事件处理程序 把一个函数赋值到一个事件的处理程序属性</li>
<li>dom2级事件处理程序 每个dom里面都有定义了两个方法addEvenListener和removeEventListener,接受三个参数:要处理的事件名(click),作为事件处理程序的函数,布尔值(true 捕获阶段调用;false 冒泡阶段调用),可以添加多个事件处理程序,ie是用不了dom2事件处理程序的,要用ie它自己的事件处理程序</li>
<li>IE事件处理程序:attachEvent,detachEvent,接受两个参数:事件处理程序的名称(onclick)和事件处理程序的函数,没有布尔值,因为ie8及之前只支持事件冒泡</li>
<li>跨浏览器(if,elseif, else)</li>
</ol>
</li>
<li>事件对象:在触发DOM上的事件时都会产生一个对象,里面有很多事件发生的属性,比如鼠标的位置,按键等<br> 在ie8以前的event要通过window.event获取<ol>
<li>DOM中的对象属性:type—用于获取事件类型(click); target—用于事件发生在的哪个目标上; stopPropagation()—用于阻止事件冒泡过程; preventDefault()—阻止事件的默认行为</li>
<li>IE中的事件对象:type—用于获取事件类型; srcElement—用于获取事件的目标对象; cancelBublle(bool)—取消冒泡; returnValue()—取消默认行为</li>
</ol>
</li>
</ol>
<h3 id="java">java</h3><p>union-find</p>
<p>QuickFindUF:<br>(course)[<a href="http://algs4.cs.princeton.edu/15uf/" target="_blank" rel="external">http://algs4.cs.princeton.edu/15uf/</a>]<br>(并查集(Union-Find)算法介绍)[<a href="http://blog.csdn.net/dm_vincent/article/details/7655764" target="_blank" rel="external">http://blog.csdn.net/dm_vincent/article/details/7655764</a>]</p>
<p>Ant</p>
<p>(ant在wiki)[<a href="http://my.ss.sysu.edu.cn/wiki/pages/viewpage.action?pageId=6521013" target="_blank" rel="external">http://my.ss.sysu.edu.cn/wiki/pages/viewpage.action?pageId=6521013</a>]</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/notes/">notes</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-服务器和nginx" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/07/23/服务器和nginx/" class="article-date">
  	<time datetime="2015-07-23T13:38:03.000Z" itemprop="datePublished">2015-07-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/23/服务器和nginx/">服务器和nginx</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这几天在帮人在阿里云上面改一个域名下访问多个网页站点,因为那个网站从代码到上线都是给别人外包做的QAQ,所以开始也无从下手…在什么都不懂的摸索过程中,自己对网页开发的后台多了一丢丢的认识.现在来写个小结吧</p>
<p>服务器其实就是一台24小时都在工作的电脑,你一样给它配系统等等(这些在阿里云那里开始设置的时候弄好),然后你可以远程登陆这台电脑(ubuntu下用ssh命令以root用户登陆),登陆以后可以分下盘,像平时自己电脑一样配置一下环境.</p>
<p>服务器和虚拟空间<br>服务器相当于就是一台存在的硬件主机了,你在服务器上可以自己通过代理器映射到不同的网站目录下,这些网站目录其实就是相当于虚拟空间,即一个服务器上面可以自己划分很多个虚拟空间</p>
<p>在网站搭建的过程中,<a href="http://nginx.org/en/docs/beginners_guide.html" target="_blank" rel="external">nginx</a><br>这种反向代理服务器(<a href="http://www.tuicool.com/articles/eiYRbu" target="_blank" rel="external">代理服务器和反向代理服务器的区别</a>)其实很重要的.我感觉它有点像路由,但是它是在服务器中根据ip/域名,路径去映射到不同的网站根目录下的,路由就是根据路径的不一样,采取不同的处理程序</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .conf</span></span><br><span class="line"><span class="title">server</span> &#123;</span><br><span class="line">    <span class="title">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="title">root</span> /data/up1;</span><br><span class="line">    <span class="title">server_name</span> example.org</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">server</span> &#123;</span><br><span class="line">    <span class="title">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="title">root</span> /data/up1;</span><br><span class="line">    <span class="title">sever_name</span> example.com</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的配置文件就是nginx的核心部分,每个server相当于一个服务器,listen—监听,root—网站代码所在的根目录,server_name—外部访问域名的名字,location—路径</p>
<p>这就说明当一个访问请求来到服务器时,实际先要经过这个nginx,将它映射到相应的网站根目录下获取index,在index中的比如<code>&lt;a href=&quot;/&quot;&gt;link&lt;/a&gt;</code>,这样的操作就是将这个访问又隐射到/处(由nginx处理),js代码中有api,里面是通过加’/msq’+router/name,nginx里面也有写这个location(/msq),但是这个不同于”/“这种,它没有获取东西,而是接着这个location来向后台传递信息.</p>
<p>后台一直在监听(0.0.0.0即全ip),一旦有请求到且要求是以/msq/开头的,就由router映射到不同的处理程序中执行再返回.</p>
<p>后台的文件不需要一定要放在根目录下的,就任意一个地方执行可以的,达到监听的目的就ok了</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/服务器/">服务器</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-js基础笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/07/18/js基础笔记/" class="article-date">
  	<time datetime="2015-07-18T14:53:55.000Z" itemprop="datePublished">2015-07-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/18/js基础笔记/">js基础笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="js的性能优化:加载和执行(链接)">js的性能优化:加载和执行(<a href="http://www.ibm.com/developerworks/cn/web/1308_caiys_jsload/index.html" target="_blank" rel="external">链接</a>)</h3><ol>
<li>脚本位置(放在后面,因为一旦遇到js的下载,后面的文件都要等待js的下载和执行,因为担心js对dom有改变)</li>
<li>组织脚本: 多个文件压缩为一个,因为多次请求并下载js文件比一次请求一个较大文件的效率要低</li>
<li>无阻塞的脚本:在页面加载完成后才加载js代码,这意味着在window对象的onload事件触发后再下载脚本:<ol>
<li>使用<code>&lt;script&gt;</code>标签的defer属性(仅适用于IE和Firefox3.5以上版本)</li>
<li>使用动态创建的<code>&lt;script&gt;</code>元素来下载并执行代码</li>
<li>使用XHR对象下载js代码并注入页面中</li>
</ol>
</li>
</ol>
<hr>
<h3 id="js的数据类型">js的数据类型</h3><p>原始值和对象</p>
<h4 id="原始值:">原始值:</h4><ul>
<li>boolean</li>
<li>null</li>
<li>undefined—&gt;一个没有被赋值的变量会有个默认值undefined</li>
<li>number(Infinity,MAX_VALUE,MIN_VALUE)</li>
<li>string(substr, concat)</li>
<li>symbol(new in ES6)</li>
</ul>
<p>原始值:除 Object 以外的所有类型都是不可变的（值本身无法被改变）。例如，与 C 语言不同，<strong>JavaScript 中字符串是不可变的</strong>（译注：如，JavaScript 中对字符串的操作一定返回了一个新字符串，原始字符串并没有被改变）。我们称这些类型的值为“原始值”。</p>
<h4 id="对象:">对象:</h4><p>A javascript object is a mapping between keys and values.Keys are string adn values can be anything.<br>Functions are regular objects with the additional capability of being callable</p>
<p>数组:数组是以数字为下标并且拥有length属性的对象。此外，数组继承了 Array.prototype 的方法，比如indexOf（搜索某个值），push(往数组里追加值)。这种特性使得数组成为列表或者集合的最佳的存储结构（数据结构）。</p>
<p>日期:内建的Date对象</p>
<hr>
<h3 id="js之typeof,constructor,instanceof">js之typeof,constructor,instanceof</h3><h4 id="typeof">typeof</h4><p>使用typeof运算符获取一个值的类型，可能的结果有5种：</p>
<ol>
<li>undefined</li>
<li>boolean</li>
<li>number</li>
<li>string</li>
<li>object<br>无论引用的是什么类型的对象,都返回”object”(除了function,但是array返回的是”object”)</li>
</ol>
<h4 id="instanceof">instanceof</h4><p>在引用类型值判断类型的时候，typeof运算符会出现一个问题，无论引用的是什么类型的对象，它都返回”object”。</p>
<p>ECMAScript引入了另一个Java运算符instanceof来解决这个问题。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span><span class="params">()</span></span>&#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">User</span><span class="params">()</span></span>&#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> u=<span class="keyword">new</span> User;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( u <span class="keyword">instanceof</span> Person ); <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( u <span class="keyword">instanceof</span> User ); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<h4 id="Object-constructor属性">Object.constructor属性</h4><p>javascript中的所有对象都继承自Object。</p>
<p>constructor是Object的一个属性，他指向：创建对象的函数的引用（指针）。（可以理解为constructor指向对象的构造函数）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> functionUser()&#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> u=<span class="keyword">new</span> User;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(u.constructor===User );<span class="comment">//得到true，也就是说对象的constructor属性指向他的构造函数。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(u.constructor.name );<span class="comment">//得到User，也就是构造函数的名称</span></span><br></pre></td></tr></table></figure></p>
<h4 id="小结:">小结:</h4><p>typeof，是一个运算符，运算中需要一个操作数，运算的结果就是这个操作数的类型，运算的结果是一个字符串。他有一定的局限性，对于对象类型的值，只能得到一个”object”结果，却不能精确得到此值的精确类型。</p>
<h2 id="示例：typeof_‘hello’_//得到”string”">示例：typeof ‘hello’ //得到”string”</h2><p>instanceof，也是一个运算符，运算中需要两个操作数，运算的结果是true或false，表示此值是不是某一个类的示例，能得到一个值的具体类型。</p>
<h2 id="示例：function_User(){}_var_u=newUser;_console-log(_u_instanceof_User_);//true">示例：function User(){}  var u=newUser;  console.log( u instanceof User );//true</h2><p>constructor是对象的一个属性，不是运算符，constructor属性指向对象的构造函数。</p>
<p>示例：function User(){}  var u=newUser;  console.log( u.constructor===User);//得到true</p>
<hr>
<h3 id="正则表达式">正则表达式</h3><p>疑问1. 实现trim函数,将字符串的开头和结尾的空白键去除.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="regexp">/^\s+|\s+$/</span>, <span class="string">''</span>);  <span class="comment">//没有设置全局变量标志g时</span></span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'   hi!  '</span>;</span><br><span class="line">str = trim(str);</span><br><span class="line"><span class="built_in">console</span>.log(str); <span class="comment">// 'hi!   ' 后面的空格还有</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//加上g后</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="regexp">/^\s+|\s+$/g</span>, <span class="string">''</span>);  <span class="comment">//没有设置全局变量标志g时</span></span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'   hi!  '</span>;</span><br><span class="line">str = trim(str);</span><br><span class="line"><span class="built_in">console</span>.log(str); <span class="comment">// 'hi!' 输出正常</span></span><br></pre></td></tr></table></figure></p>
<p>全局标志的意义何在?<br> 在创建正则表达式对象时如果使用了“g”标识符或者设置它了的﻿global属性值为ture时，那么新创建的正则表达式对象将使用模式对要将要匹配的字符串进行全局匹配。在全局匹配模式下可以对指定要查找的字符串执行多次匹配。每次匹配使用当前正则对象的lastIndex属性的值作为在目标字符串中开始查找的起始位置。lastIndex属性的初始值为0，找到匹配的项后lastIndex的值被重置为匹配内容的下一个字符在字符串中的位置索引，用来标识下次执行匹配时开始查找的位置。如果找不到匹配的项lastIndex的值会被设置为0。当没有设置正则对象的全局匹配标志时lastIndex属性的值始终为0，每次执行匹配仅查找字符串中第一个匹配的项。</p>
<p> 简而言之,寻找匹配项就是有一个下标的,一开始都是0,在全局下的话可以多次匹配如果找到一个匹配项,那么下标就更新,下次匹配的时候就从那个新的下标开始.如果不设全局的话,那下标总是从0开始,就总是只能找到第一项匹配项.</p>
<hr>
<h2 id="dom篇">dom篇</h2><p>NodeList不是Array.通过document.getElementsByTagName之类获得的NodeList虽然是list,但是不是array,NodeList的下一层直接就是Object了(所以没有很多Array的方法属性)</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笔记/">笔记</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 ailin
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>