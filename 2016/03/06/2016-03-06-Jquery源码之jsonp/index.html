<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JQuery中的jsonp源码剖析 | ailin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="问题背景不久之前遇到过跨域问题，google以后知道这是由于同源策略导致的，我们要利用script，img类似等标签去跨域访问，同时还需要服务器后台的配合返回的js里面是包含我们想要的“回调函数”的调用。
当时的解决方法直接使用jquery的ajax，在里面的dataType设置为jsonp就解决了这个问题
问题延展由于跨域问题十分常见，所以我想探究一下jquery里面是如何实现jsonp的，并且">
<meta property="og:type" content="article">
<meta property="og:title" content="JQuery中的jsonp源码剖析">
<meta property="og:url" content="http://dengal3.github.com/2016/03/06/2016-03-06-Jquery源码之jsonp/index.html">
<meta property="og:site_name" content="ailin">
<meta property="og:description" content="问题背景不久之前遇到过跨域问题，google以后知道这是由于同源策略导致的，我们要利用script，img类似等标签去跨域访问，同时还需要服务器后台的配合返回的js里面是包含我们想要的“回调函数”的调用。
当时的解决方法直接使用jquery的ajax，在里面的dataType设置为jsonp就解决了这个问题
问题延展由于跨域问题十分常见，所以我想探究一下jquery里面是如何实现jsonp的，并且">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JQuery中的jsonp源码剖析">
<meta name="twitter:description" content="问题背景不久之前遇到过跨域问题，google以后知道这是由于同源策略导致的，我们要利用script，img类似等标签去跨域访问，同时还需要服务器后台的配合返回的js里面是包含我们想要的“回调函数”的调用。
当时的解决方法直接使用jquery的ajax，在里面的dataType设置为jsonp就解决了这个问题
问题延展由于跨域问题十分常见，所以我想探究一下jquery里面是如何实现jsonp的，并且">
  
    <link rel="alternative" href="/atom.xml" title="ailin" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/logo.jpg">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="images/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ailin</a></h1>
		</hgroup>

		
		<p class="header-subtitle">其实这是流水账</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dengal3" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1793490742" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dengal" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Jquery/" style="font-size: 10px;">Jquery</a><a href="/tags/chrome-extension/" style="font-size: 10px;">chrome extension</a><a href="/tags/css/" style="font-size: 20px;">css</a><a href="/tags/hexo/" style="font-size: 10px;">hexo</a><a href="/tags/javascipt/" style="font-size: 10px;">javascipt</a><a href="/tags/javascript/" style="font-size: 20px;">javascript</a><a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a><a href="/tags/js/" style="font-size: 10px;">js</a><a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a><a href="/tags/nginx/" style="font-size: 10px;">nginx</a><a href="/tags/notes/" style="font-size: 10px;">notes</a><a href="/tags/object-oriented/" style="font-size: 10px;">object-oriented</a><a href="/tags/os/" style="font-size: 10px;">os</a><a href="/tags/pintos/" style="font-size: 20px;">pintos</a><a href="/tags/setTimeout/" style="font-size: 10px;">setTimeout</a><a href="/tags/thinking/" style="font-size: 20px;">thinking</a><a href="/tags/thread/" style="font-size: 10px;">thread</a><a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a><a href="/tags/假期/" style="font-size: 20px;">假期</a><a href="/tags/基本功/" style="font-size: 10px;">基本功</a><a href="/tags/外排序/" style="font-size: 10px;">外排序</a><a href="/tags/学习记录/" style="font-size: 10px;">学习记录</a><a href="/tags/定时器/" style="font-size: 10px;">定时器</a><a href="/tags/布局/" style="font-size: 20px;">布局</a><a href="/tags/数据库/" style="font-size: 20px;">数据库</a><a href="/tags/日常/" style="font-size: 10px;">日常</a><a href="/tags/服务器/" style="font-size: 10px;">服务器</a><a href="/tags/树结构索引/" style="font-size: 10px;">树结构索引</a><a href="/tags/源码剖析/" style="font-size: 10px;">源码剖析</a><a href="/tags/笔记/" style="font-size: 10px;">笔记</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://daixuan.me">DX的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://54017.github.io">017的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">你希望能看到什么?</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ailin</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="images/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">ailin</h1>
			</hgroup>
			
			<p class="header-subtitle">其实这是流水账</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dengal3" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1793490742" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dengal" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2016-03-06-Jquery源码之jsonp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/06/2016-03-06-Jquery源码之jsonp/" class="article-date">
  	<time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished">2016-03-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      JQuery中的jsonp源码剖析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jquery/">Jquery</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jsonp/">jsonp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码剖析/">源码剖析</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="问题背景">问题背景</h5><p>不久之前遇到过跨域问题，google以后知道这是由于<strong>同源策略</strong>导致的，我们要利用script，img类似等标签去跨域访问，同时还需要服务器后台的配合返回的js里面是包含我们想要的“回调函数”的调用。</p>
<h5 id="当时的解决方法">当时的解决方法</h5><p>直接使用jquery的ajax，在里面的dataType设置为jsonp就解决了这个问题</p>
<h5 id="问题延展">问题延展</h5><p>由于跨域问题十分常见，所以我想探究一下jquery里面是如何实现jsonp的，并且可以做到接口高度抽象的。</p>
<p>正式进入源码分析<br><a href="https://github.com/jquery/jquery/" target="_blank" rel="external">[源码地址]</a><br>一般我们是这么调用ajax的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$<span class="class">.ajax</span>(<span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">url</span>:<span class="value"> <span class="string">"http://"</span>+url,</span><br><span class="line">    type: <span class="string">'GET'</span>,</span><br><span class="line">    dataType: <span class="string">'JSONP'</span>,  // cross-orign</span><br><span class="line">    success: <span class="function">function</span>(data) &#123;</span><br><span class="line">        _this.<span class="function">setState</span>(&#123;bubbles: data&#125;)</span></span>;</span><br><span class="line">    &#125;</span>,</span><br><span class="line">    <span class="rule"><span class="attribute">error</span>:<span class="value"> <span class="function">function</span>(e) &#123;</span><br><span class="line">        console.<span class="function">log</span>(e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们要先找到ajax的入口，这是一段相当长的代码，我会跳出核心重要的地方出来<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 383 at ajax.js</span></span><br><span class="line">ajax: <span class="function"><span class="keyword">function</span><span class="params">( url, options )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If url is an object, simulate pre-1.5 signature</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> url === <span class="string">"object"</span> ) &#123;</span><br><span class="line">            options = url;</span><br><span class="line">            url = <span class="literal">undefined</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Force options to be an object</span></span><br><span class="line">        options = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">            Continue to be</span><br><span class="line">        *</span></span><br></pre></td></tr></table></figure></p>
<p>结合我们之前调用ajax的例子，我们可以看到我们传入的对应url的是一个对象，所以options将会变为我们传入的对象，而url会变为undefined。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">options</span> = <span class="keyword">options</span> || &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>jquery里面常见的赋值方法,为了确保值的类型，减少会有很多undefined的情况。</p>
<p>我们继续看<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 422</span></span><br><span class="line">    <span class="comment">// Create the final options object</span></span><br><span class="line">    s = jQuery.<span class="function"><span class="title">ajaxSetup</span><span class="params">( &#123;&#125;, options )</span></span></span><br></pre></td></tr></table></figure></p>
<p>这里出现了一个重要的函数ajaxSetup，它调用了options，返回了一个东西给s，这个s我们会在后面的代码中频繁地看到。</p>
<p>因此我们去看下ajaxSetup的具体实现<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a full fledged settings object into target</span></span><br><span class="line"><span class="comment">// with both ajaxSettings and settings fields.</span></span><br><span class="line"><span class="comment">// If target is omitted, writes into ajaxSettings.</span></span><br><span class="line">ajaxSetup: function( <span class="keyword">target</span>, settings ) &#123;</span><br><span class="line">    <span class="keyword">return</span> settings ?</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Building a settings object</span></span><br><span class="line">        ajaxExtend( ajaxExtend( <span class="keyword">target</span>, jQuery.ajaxSettings ), settings ) :</span><br><span class="line"></span><br><span class="line">        // Extending ajaxSettings</span><br><span class="line">        ajaxExtend( jQuery.ajaxSettings, <span class="keyword">target</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的target是我们传入的空对象{}，settings就是我们的options，这里又调用了ajaxExtend和ajaxSettings来新建一个settings对象。我们去看看这两个相关的代码。</p>
<p>来看看ajaxSettings的相关代码，真够长的，这些都是相当于默认的配置属性，有些用来设置请求头的属性等等。<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 299</span></span><br><span class="line">ajaxSettings: &#123;</span><br><span class="line">    url: location.href,</span><br><span class="line">    <span class="class"><span class="keyword">type</span>: "<span class="title">GET</span>",</span></span><br><span class="line">    isLocal: rlocalProtocol.test( location.protocol ),</span><br><span class="line">    <span class="keyword">global</span>: <span class="keyword">true</span>,</span><br><span class="line">    processData: <span class="keyword">true</span>,</span><br><span class="line">    async: <span class="keyword">true</span>,</span><br><span class="line">    contentType: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">    /*</span><br><span class="line">    timeout: <span class="number">0</span>,</span><br><span class="line">    data: <span class="keyword">null</span>,</span><br><span class="line">    dataType: <span class="keyword">null</span>,</span><br><span class="line">    username: <span class="keyword">null</span>,</span><br><span class="line">    password: <span class="keyword">null</span>,</span><br><span class="line">    cache: <span class="keyword">null</span>,</span><br><span class="line">    throws: <span class="keyword">false</span>,</span><br><span class="line">    traditional: <span class="keyword">false</span>,</span><br><span class="line">    headers: &#123;&#125;,</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    accepts: &#123;</span><br><span class="line">        <span class="string">"*"</span>: allTypes,</span><br><span class="line">        text: <span class="string">"text/plain"</span>,</span><br><span class="line">        html: <span class="string">"text/html"</span>,</span><br><span class="line">        xml: <span class="string">"application/xml, text/xml"</span>,</span><br><span class="line">        json: <span class="string">"application/json, text/javascript"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    contents: &#123;</span><br><span class="line">        xml: /\bxml\b/,</span><br><span class="line">        html: /\bhtml/,</span><br><span class="line">        json: /\bjson\b/</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    responseFields: &#123;</span><br><span class="line">        xml: <span class="string">"responseXML"</span>,</span><br><span class="line">        text: <span class="string">"responseText"</span>,</span><br><span class="line">        json: <span class="string">"responseJSON"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Data converters</span></span><br><span class="line">    <span class="comment">// Keys separate source (or catchall "*") and destination types with a single space</span></span><br><span class="line">    converters: &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert anything to text</span></span><br><span class="line">        <span class="string">"* text"</span>: String,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Text to html (true = no transformation)</span></span><br><span class="line">        <span class="string">"text html"</span>: <span class="keyword">true</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Evaluate text as a json expression</span></span><br><span class="line">        <span class="string">"text json"</span>: JSON.parse,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Parse text as xml</span></span><br><span class="line">        <span class="string">"text xml"</span>: jQuery.parseXML</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For options that shouldn't be deep extended:</span></span><br><span class="line">    <span class="comment">// you can add your own custom options here if</span></span><br><span class="line">    <span class="comment">// and when you create one that shouldn't be</span></span><br><span class="line">    <span class="comment">// deep extended (see ajaxExtend)</span></span><br><span class="line">    flatOptions: &#123;</span><br><span class="line">        url: <span class="keyword">true</span>,</span><br><span class="line">        context: <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是ajaxExtend的实现代码<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A special extend for ajax options</span></span><br><span class="line"><span class="comment">// that takes "flat" options (not to be deep extended)</span></span><br><span class="line"><span class="comment">// Fixes #9887</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxExtend</span><span class="params">( target, src )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key, deep,</span><br><span class="line">        flatOptions = jQuery.ajaxSettings.flatOptions || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( key <span class="keyword">in</span> src ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( src[ key ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">            ( flatOptions[ key ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ key ] = src[ key ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">        jQuery.extend( <span class="literal">true</span>, target, deep );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们再看看我们之前找到的ajaxSetup代码<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a full fledged settings object into target</span></span><br><span class="line"><span class="comment">// with both ajaxSettings and settings fields.</span></span><br><span class="line"><span class="comment">// If target is omitted, writes into ajaxSettings.</span></span><br><span class="line">ajaxSetup: function( <span class="keyword">target</span>, settings ) &#123;</span><br><span class="line">    <span class="keyword">return</span> settings ?</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Building a settings object</span></span><br><span class="line">        ajaxExtend( ajaxExtend( <span class="keyword">target</span>, jQuery.ajaxSettings ), settings ) :</span><br><span class="line"></span><br><span class="line">        // Extending ajaxSettings</span><br><span class="line">        ajaxExtend( jQuery.ajaxSettings, <span class="keyword">target</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们知道了jQueryajaxSettings就是一堆的对象属性而已，因此我们把重点放在ajaxExtend上</p>
<p>（为了思路可以更清晰，可能同一个函数的代码会出现多次，比较方便看）<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A special extend for ajax options</span></span><br><span class="line"><span class="comment">// that takes "flat" options (not to be deep extended)</span></span><br><span class="line"><span class="comment">// Fixes #9887</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxExtend</span><span class="params">( target, src )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key, deep,</span><br><span class="line">        flatOptions = jQuery.ajaxSettings.flatOptions || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( key <span class="keyword">in</span> src ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( src[ key ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">            ( flatOptions[ key ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ key ] = src[ key ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">        jQuery.extend( <span class="literal">true</span>, target, deep );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前我们在ajaxSetup里面第一个调用ajaxExtend的时候是<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ajaxExtend</span><span class="params">( target, jQuery.ajaxSettings )</span></span>；</span><br></pre></td></tr></table></figure></p>
<p>很明显，就是想把ajaxSettings的属性都扩展到target（现在还是{}）上面去。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend</span></span><br><span class="line">flatOptions = jQuery.ajaxSettings.flatOptions <span class="string">|| &#123;&#125;;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">ajaxSettings</span>: &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        a lot of stuff here</span><br><span class="line">    */</span></span><br><span class="line">    <span class="tag">flatOptions</span>: &#123;</span><br><span class="line">        <span class="attribute">url</span>: true,</span><br><span class="line">        <span class="attribute">context</span>: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们传入的<code>ajaxExtend( target, src )</code>中的target是{}，src此时是ajaxSettings<br>我们要返回去看ajaxSettings，可以看到里面除了url的键，但我没看到有context这个键，对此我也很是疑惑，还有很多其他的键，这是flatOptions里面没有的属性。<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend function</span></span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">key</span> in src ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( src[ <span class="variable">key</span> ] !== undefined ) &#123;</span><br><span class="line">        ( flatOptions[ <span class="variable">key</span> ] ? target : ( deep || ( deep = &#123;&#125; ) ) )[ <span class="variable">key</span> ] = src[ <span class="variable">key</span> ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这时候我们认真地想一下，就可以发现除了url和context属性之外的属性都会被赋值到deep上面，target即开始的空对象{}就只有url和context键和键值赋值上去。</p>
<p>即经过第一个ajaxExtend函数调用之后，首先我们的target, deep变成了<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">target:</span> &#123;</span><br><span class="line"><span class="label">    url:</span> location.href,</span><br><span class="line"><span class="label">    context:</span> undefined,  <span class="comment">// smg？！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">deep :</span> &#123;</span><br><span class="line">    ajaxSettings里除了url和context的所有属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后deep<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of ajaxExtend</span></span><br><span class="line"><span class="keyword">if</span> ( deep ) &#123;</span><br><span class="line">    jQuery.extend( <span class="keyword">true</span>, <span class="keyword">target</span>, deep );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>deep看来是又被加到target那里，所以现在的target变成了<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">target</span>: &#123;</span><br><span class="line">    <span class="attribute">url</span>: location.href,</span><br><span class="line">    <span class="attribute">context</span>: undefined,  <span class="comment">// smg？！</span></span><br><span class="line">    所有其他的ajaxSettings里面的属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后target返回，再次调用ajaxExtend<br><code>ajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings )</code>，这时是将刚刚返回的target和settings（即我们最开始传进去ajax的那个对象）放到ajaxExtend里面去调用。</p>
<p>捋一捋，现在target和settings是什么东西<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">target: &#123;</span><br><span class="line">    url: location.href,</span><br><span class="line">    context: <span class="literal">undefined</span>,  <span class="comment">// smg？！</span></span><br><span class="line">    所有其他的ajaxSettings里面的属性</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们自己调用ajax的时候传入的对象</span></span><br><span class="line">settings: &#123;</span><br><span class="line">    url: <span class="string">"http://"</span>+url,</span><br><span class="line">    type: <span class="string">'GET'</span>,</span><br><span class="line">    dataType: <span class="string">'JSONP'</span>,  <span class="comment">// cross-orign</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">        _this.setState(&#123;bubbles: data&#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个作为形参调用ajaxExtend，分析手法和上述类似，这里就同理了。<br>返回的最终对象target就是包含了所有ajaxSettings属性在内，键值之后被我们自己传入的对象属性覆盖更新，context为undefined的对象。</p>
<p>这里面我们就知道了前面的对象s就是这个最终对象target了，难怪要命名成s，其实说白了就是一个有很多属性在里面的对象，settings而已。</p>
<p>因此我们又回到了ajax这个主函数里面的第422行之后的代码上。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Callbacks <span class="keyword">context</span></span><br><span class="line">callbackContext = s.<span class="keyword">context</span> || s,</span><br><span class="line"></span><br><span class="line">// <span class="keyword">Context</span> <span class="keyword">for</span> global events <span class="keyword">is</span> callbackContext <span class="keyword">if</span> it <span class="keyword">is</span> a DOM node <span class="keyword">or</span> jQuery collection</span><br><span class="line">globalEventContext = s.<span class="keyword">context</span> &amp;&amp;</span><br><span class="line">    ( callbackContext.nodeType || callbackContext.jquery ) ?</span><br><span class="line">        jQuery( callbackContext ) :</span><br><span class="line">        jQuery.event,</span><br></pre></td></tr></table></figure></p>
<p>s.context是undefined的，所以callbackContent变成s，callbackContent里面也没有nodeType和jquery，因此，globalEventContext变成了jQuery.event.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jQuery.event = &#123;</span><br><span class="line">    add: <span class="function"><span class="keyword">function</span> <span class="params">( elem, types, handler, data, selector )</span> </span>&#123;</span><br><span class="line">    dispatch: <span class="function"><span class="keyword">function</span> <span class="params">( event )</span> </span>&#123;</span><br><span class="line">    fix: <span class="function"><span class="keyword">function</span> <span class="params">( event )</span> </span>&#123;</span><br><span class="line">    fixHooks: <span class="built_in">Object</span></span><br><span class="line">    global: <span class="built_in">Object</span></span><br><span class="line">    handlers: <span class="function"><span class="keyword">function</span> <span class="params">( event, handlers )</span> </span>&#123;</span><br><span class="line">    keyHooks: <span class="built_in">Object</span></span><br><span class="line">    mouseHooks: <span class="built_in">Object</span></span><br><span class="line">    props: <span class="built_in">Array</span>[<span class="number">14</span>]</span><br><span class="line">    remove: <span class="function"><span class="keyword">function</span> <span class="params">( elem, types, handler, selector, mappedTypes )</span> </span>&#123;</span><br><span class="line">    simulate: <span class="function"><span class="keyword">function</span> <span class="params">( type, elem, event )</span> </span>&#123;</span><br><span class="line">    special: <span class="built_in">Object</span></span><br><span class="line">    trigger: <span class="function"><span class="keyword">function</span> <span class="params">( event, data, elem, onlyHandlers )</span> </span>&#123;</span><br><span class="line">    __proto__: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个是我用浏览器打开设断点以后看到event的具体属性，为了解说可以推进得更快。</p>
<p>我们继续<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 433</span></span><br><span class="line"><span class="comment">// Deferreds</span></span><br><span class="line">deferred = jQuery.Deferred(),</span><br><span class="line">completeDeferred = jQuery.Callbacks( <span class="string">"once memory"</span> ),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Status-dependent callbacks</span></span><br><span class="line">statusCode = s.statusCode <span class="string">|| &#123;&#125;,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Headers (they are sent all at once)</span></span><br><span class="line">requestHeaders = &#123;&#125;,</span><br><span class="line">requestHeadersNames = &#123;&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default abort message</span></span><br><span class="line">strAbort = <span class="string">"canceled"</span>,</span><br></pre></td></tr></table></figure></p>
<p>这里都是一些相关的设置，暂时还不太重要，我们可以快速跳过。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 448</span></span><br><span class="line"><span class="comment">// Fake xhr</span></span><br><span class="line">jqXHR = &#123;</span><br><span class="line">    readyState: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Builds headers hashtable if needed</span></span><br><span class="line">    getResponseHeader: <span class="function"><span class="keyword">function</span><span class="params">( key )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> match;</span><br><span class="line">        <span class="keyword">if</span> ( completed ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !responseHeaders ) &#123;</span><br><span class="line">                responseHeaders = &#123;&#125;;</span><br><span class="line">                <span class="keyword">while</span> ( ( match = rheaders.exec( responseHeadersString ) ) ) &#123;</span><br><span class="line">                    responseHeaders[ match[ <span class="number">1</span> ].toLowerCase() ] = match[ <span class="number">2</span> ];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            match = responseHeaders[ key.toLowerCase() ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match == <span class="literal">null</span> ? <span class="literal">null</span> : match;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Raw string</span></span><br><span class="line">    getAllResponseHeaders: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> completed ? responseHeadersString : <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Caches the header</span></span><br><span class="line">    setRequestHeader: <span class="function"><span class="keyword">function</span><span class="params">( name, value )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( completed == <span class="literal">null</span> ) &#123;</span><br><span class="line">            name = requestHeadersNames[ name.toLowerCase() ] =</span><br><span class="line">                requestHeadersNames[ name.toLowerCase() ] || name;</span><br><span class="line">            requestHeaders[ name ] = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Overrides response content-type header</span></span><br><span class="line">    overrideMimeType: <span class="function"><span class="keyword">function</span><span class="params">( type )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( completed == <span class="literal">null</span> ) &#123;</span><br><span class="line">            s.mimeType = type;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status-dependent callbacks</span></span><br><span class="line">    statusCode: <span class="function"><span class="keyword">function</span><span class="params">( map )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> code;</span><br><span class="line">        <span class="keyword">if</span> ( map ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( completed ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Execute the appropriate callbacks</span></span><br><span class="line">                jqXHR.always( map[ jqXHR.status ] );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Lazy-add the new callbacks in a way that preserves old ones</span></span><br><span class="line">                <span class="keyword">for</span> ( code <span class="keyword">in</span> map ) &#123;</span><br><span class="line">                    statusCode[ code ] = [ statusCode[ code ], map[ code ] ];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cancel the request</span></span><br><span class="line">    abort: <span class="function"><span class="keyword">function</span><span class="params">( statusText )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> finalText = statusText || strAbort;</span><br><span class="line">        <span class="keyword">if</span> ( transport ) &#123;</span><br><span class="line">            transport.abort( finalText );</span><br><span class="line">        &#125;</span><br><span class="line">        done( <span class="number">0</span>, finalText );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 认真观察这段代码发现有几个属性是比较关键的，一个是completed，一个是transport，都是这些函数的if里面判断的属性。我们到前面去看看这两个属性。<br> <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// line <span class="number">410</span></span><br><span class="line">// Request <span class="keyword">state</span> (becomes false upon send and true upon completion)</span><br><span class="line">    completed,</span><br><span class="line"></span><br><span class="line">// transport没有注释，所以暂时未知，可以猜测是</span><br></pre></td></tr></table></figure></p>
<p>上面jqXHR的对象里面的属性命名大概就是他们的作用了，我们知道了这应该是控制请求的头呀等等的属性和收到请求以后的一些操作函数。</p>
<p>我们继续ajax部分的<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 520</span></span><br><span class="line"><span class="comment">// Attach deferreds</span></span><br><span class="line">deferred.promise<span class="comment">( jqXHR )</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们看到了一个promise，我们对这种名字的函数应该要比较敏感（node里面也有promise的函数），我们可以深入去了解一下这个函数。</p>
<p>那我们就必须要先看deferred这个对象。这是前面的一个对象。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 434</span></span><br><span class="line"><span class="comment">// Deferreds</span></span><br><span class="line">deferred = jQuery.<span class="function"><span class="title">Deferred</span><span class="params">()</span></span>,</span><br><span class="line">completeDeferred = jQuery.<span class="function"><span class="title">Callbacks</span><span class="params">( <span class="string">"once memory"</span> )</span></span>,</span><br></pre></td></tr></table></figure></p>
<p>同样的我也是在浏览器里面去查看这个对象的属性<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">deferred = &#123;</span><br><span class="line">    always: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    done: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    fail: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    notify: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    notifyWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    pipe: <span class="function"><span class="keyword">function</span> <span class="params">( <span class="comment">/* fnDone, fnFail, fnProgress */</span> )</span> </span>&#123;</span><br><span class="line">    progress: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    promise: <span class="function"><span class="keyword">function</span> <span class="params">( obj )</span> </span>&#123;</span><br><span class="line">    reject: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    rejectWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    resolve: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    resolveWith: <span class="function"><span class="keyword">function</span> <span class="params">( context, args )</span> </span>&#123;</span><br><span class="line">    state: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    then: <span class="function"><span class="keyword">function</span> <span class="params">( <span class="comment">/* fnDone, fnFail, fnProgress */</span> )</span> </span>&#123;</span><br><span class="line">    __proto__: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们有时间的话再去看看promise（由于不够时间的原因），我们大概知道promise就要有异步的操作，对应这里的话就应该是异步发出请求吧。</p>
<p>好，我们继续ajax的主要函数部分。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// <span class="type">Add</span> protocol <span class="keyword">if</span> <span class="keyword">not</span> provided (prefilters might expect it)</span><br><span class="line">// <span class="type">Handle</span> falsy url <span class="keyword">in</span> the settings <span class="keyword">object</span> (<span class="comment">#10093: consistency with old signature)</span></span><br><span class="line">// <span class="type">We</span> also use the url parameter <span class="keyword">if</span> available</span><br><span class="line">s.url = ( ( url || s.url || location.href ) + <span class="string">""</span> )</span><br><span class="line">    .replace( rprotocol, location.protocol + <span class="string">"//"</span> );</span><br><span class="line"></span><br><span class="line">// <span class="type">Alias</span> <span class="keyword">method</span> option to <span class="keyword">type</span> <span class="keyword">as</span> per ticket <span class="comment">#12004</span></span><br><span class="line">s.<span class="keyword">type</span> = options.<span class="keyword">method</span> || options.<span class="keyword">type</span> || s.<span class="keyword">method</span> || s.<span class="keyword">type</span>;</span><br><span class="line"></span><br><span class="line">// <span class="type">Extract</span> dataTypes list</span><br><span class="line">s.dataTypes = jQuery.trim( s.dataType || <span class="string">"*"</span> ).toLowerCase().match( rnotwhite ) || [ <span class="string">""</span> ];</span><br></pre></td></tr></table></figure></p>
<p>设置请求的url，类型，传送的数据类型。（注意：我们可是jsonp）</p>
<p>接着<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A cross-domain request is in order when the origin doesn't match the current origin.</span></span><br><span class="line"><span class="keyword">if</span> ( s.crossDomain == <span class="keyword">null</span> ) &#123;</span><br><span class="line">    urlAnchor = <span class="built_in">document</span>.createElement( <span class="string">"a"</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Support: IE8-11+</span></span><br><span class="line">    <span class="comment">// IE throws exception if url is malformed, e.g. http://example.com:80x/</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        urlAnchor.href = s.url;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Support: IE8-11+</span></span><br><span class="line">        <span class="comment">// Anchor's host property isn't correctly set when s.url is relative</span></span><br><span class="line">        urlAnchor.href = urlAnchor.href;</span><br><span class="line">        s.crossDomain = originAnchor.protocol + <span class="string">"//"</span> + originAnchor.host !==</span><br><span class="line">            urlAnchor.protocol + <span class="string">"//"</span> + urlAnchor.host;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( e ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there is an error parsing the URL, assume it is crossDomain,</span></span><br><span class="line">        <span class="comment">// it can be rejected by the transport if it is invalid</span></span><br><span class="line">        s.crossDomain = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里s.crossDomain是undefined，但是<code>s.crossDomain == null</code>返回的是true<br>在这段代码中，实际作用是<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s.crossDomain = originAnchor.protocol + <span class="string">"//"</span> + originAnchor.<span class="keyword">host</span> !==</span><br><span class="line">            urlAnchor.protocol + <span class="string">"//"</span> + urlAnchor.<span class="keyword">host</span>;</span><br></pre></td></tr></table></figure></p>
<p>判断是否有跨域行为</p>
<p>继续ajax主函数里面的代码<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Convert data if not already a string</span></span><br><span class="line"><span class="keyword">if</span> ( s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">&amp;&amp;</span> s<span class="built_in">.</span>processData <span class="subst">&amp;&amp;</span> typeof s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">!==</span> <span class="string">"string"</span> ) &#123;</span><br><span class="line">    s<span class="built_in">.</span><span class="built_in">data</span> <span class="subst">=</span> jQuery<span class="built_in">.</span>param( s<span class="built_in">.</span><span class="built_in">data</span>, s<span class="built_in">.</span>traditional );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将传输的数据全都转换为string</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure>
<p><code>inspectPrefilterOrTransports</code>这是ajax里面重要的函数</p>
<p>我们去认真地看一下这个函数的实现代码，再结合我们调用的参数<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>prefilters是外部函数的变量，开始为{}（按理说是空对象的，但是我在浏览器中观察的时候发现是有json，jsonp和script这些属性的，我开始的时候也觉得很迷惑），但是在我们调用ajax之前，实际我们已经调用了ajaxSetup, ajaxPrefilter这些函数，这是在jsonp.js里面调用的，是在js文件加载的时候就调用的，这也算是一个挺重要的小插曲，也会影响到我们后面的分析，所以我们还是要去看一下jsonp相关的代码。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default jsonp settings</span></span><br><span class="line">jQuery.ajaxSetup( &#123;</span><br><span class="line">    jsonp: <span class="string">"callback"</span>,</span><br><span class="line">    jsonpCallback: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">callback</span> = oldCallbacks.pop() || ( jQuery.expando + <span class="string">"_"</span> + ( nonce++ ) );</span><br><span class="line">        <span class="keyword">this</span>[ <span class="keyword">callback</span> ] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect, normalize options and install callbacks for jsonp requests</span></span><br><span class="line">jQuery.ajaxPrefilter( <span class="string">"json jsonp"</span>, <span class="function"><span class="keyword">function</span><span class="params">( s, originalSettings, jqXHR )</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        a lot of stuff here</span><br><span class="line">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在开始的时候就把jsonp和jsonCallback这两个属性加载我们的s那里去了，如果你还记得我们前面的分析过程的话，而ajaxPrefilter<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ajax.js line 379</span></span><br><span class="line">ajaxPrefilter: addToPrefiltersOrTransports( prefilters )</span><br><span class="line"></span><br><span class="line"><span class="comment">// ajax.js line 53</span></span><br><span class="line"><span class="comment">// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addToPrefiltersOrTransports</span><span class="params">( structure )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dataTypeExpression is optional and defaults to "*"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">( dataTypeExpression, func )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeExpression !== <span class="string">"string"</span> ) &#123;</span><br><span class="line">            func = dataTypeExpression;</span><br><span class="line">            dataTypeExpression = <span class="string">"*"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dataType,</span><br><span class="line">            i = <span class="number">0</span>,</span><br><span class="line">            dataTypes = dataTypeExpression.toLowerCase().match( rnotwhite ) || [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( jQuery.isFunction( func ) ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// For each dataType in the dataTypeExpression</span></span><br><span class="line">            <span class="keyword">while</span> ( ( dataType = dataTypes[ i++ ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Prepend if requested</span></span><br><span class="line">                <span class="keyword">if</span> ( dataType[ <span class="number">0</span> ] === <span class="string">"+"</span> ) &#123;</span><br><span class="line">                    dataType = dataType.slice( <span class="number">1</span> ) || <span class="string">"*"</span>;</span><br><span class="line">                    ( structure[ dataType ] = structure[ dataType ] || [] ).unshift( func );</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Otherwise append</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ( structure[ dataType ] = structure[ dataType ] || [] ).push( func );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单说来就是structure作为一个对象，这里就是我们的prefilters，原本是{}空对象，然后将dataTypeExpression，即我们这里的“json jsonp”用正则提取出所有的类型，然后当做键，键值是数组，把func，即跟在“json jsonp”传入的长长的匿名函数，推入到键值数组中。</p>
<p>我们基本知道了jsonp那里发生了什么事，我们再回到ajax.js，我们刚刚讲到<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply prefilters</span></span><br><span class="line">inspectPrefiltersOrTransports( prefilters, s, <span class="keyword">options</span>, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>prefilters这个时候是一个有json，jsonp属性的对象，s是settings，options是我们传入的对象，jqXHR是我们要发的请求。</p>
<p><code>inspectPrefiltersOrTransports</code>函数实现<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Base inspection function for prefilters and transports</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inspectPrefiltersOrTransports</span><span class="params">( structure, options, originalOptions, jqXHR )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> inspected = &#123;&#125;,</span><br><span class="line">        seekingTransport = ( structure === transports );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> selected;</span><br><span class="line">        inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">        jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">            <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">                !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">                options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">                inspect( dataTypeOrTransport );</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">                <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; );</span><br><span class="line">        <span class="keyword">return</span> selected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inspect( options.dataTypes[ <span class="number">0</span> ] ) || !inspected[ <span class="string">"*"</span> ] &amp;&amp; inspect( <span class="string">"*"</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>options是总的settings，里面的dataTypes是经过我们自己传进去的对象更新过的，dataTypes此时只有jsonp的属性，即我们inspect（“jsonp”）这样子。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selected;</span><br><span class="line">    inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">    jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">            !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">            options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">            inspect( dataTypeOrTransport );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">            <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看看这个函数<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> dataTypeOrTransport</span> = prefilterOrFactory( options, originalOptions, jqXHR );</span><br></pre></td></tr></table></figure></p>
<p>在这里的<code>prefilterOrFactory</code>是指在jsonp.js传入的那个匿名函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span><span class="params">( s, originalSettings, jqXHR )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> callbackName, overwritten, responseContainer,</span><br><span class="line">        jsonProp = s.jsonp !== <span class="literal">false</span> &amp;&amp; ( rjsonp.test( s.url ) ?</span><br><span class="line">            <span class="string">"url"</span> :</span><br><span class="line">            <span class="keyword">typeof</span> s.data === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">                ( s.contentType || <span class="string">""</span> )</span><br><span class="line">                    .indexOf( <span class="string">"application/x-www-form-urlencoded"</span> ) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">                rjsonp.test( s.data ) &amp;&amp; <span class="string">"data"</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle iff the expected data type is "jsonp" or we have a parameter to set</span></span><br><span class="line">    <span class="keyword">if</span> ( jsonProp || s.dataTypes[ <span class="number">0</span> ] === <span class="string">"jsonp"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get callback name, remembering preexisting value associated with it</span></span><br><span class="line">        callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?</span><br><span class="line">            s.jsonpCallback() :</span><br><span class="line">            s.jsonpCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Insert callback into url or form data</span></span><br><span class="line">        <span class="keyword">if</span> ( jsonProp ) &#123;</span><br><span class="line">            s[ jsonProp ] = s[ jsonProp ].replace( rjsonp, <span class="string">"$1"</span> + callbackName );</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( s.jsonp !== <span class="literal">false</span> ) &#123;</span><br><span class="line">            s.url += ( rquery.test( s.url ) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span> ) + s.jsonp + <span class="string">"="</span> + callbackName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use data converter to retrieve json after script execution</span></span><br><span class="line">        s.converters[ <span class="string">"script json"</span> ] = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ( !responseContainer ) &#123;</span><br><span class="line">                jQuery.error( callbackName + <span class="string">" was not called"</span> );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> responseContainer[ <span class="number">0</span> ];</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Force json dataType</span></span><br><span class="line">        s.dataTypes[ <span class="number">0</span> ] = <span class="string">"json"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Install callback</span></span><br><span class="line">        overwritten = <span class="built_in">window</span>[ callbackName ];</span><br><span class="line">        <span class="built_in">window</span>[ callbackName ] = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            responseContainer = <span class="built_in">arguments</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean-up function (fires after converters)</span></span><br><span class="line">        jqXHR.always( <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If previous value didn't exist - remove it</span></span><br><span class="line">            <span class="keyword">if</span> ( overwritten === <span class="literal">undefined</span> ) &#123;</span><br><span class="line">                jQuery( <span class="built_in">window</span> ).removeProp( callbackName );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Otherwise restore preexisting value</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">window</span>[ callbackName ] = overwritten;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Save back as free</span></span><br><span class="line">            <span class="keyword">if</span> ( s[ callbackName ] ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure that re-using the options doesn't screw things around</span></span><br><span class="line">                s.jsonpCallback = originalSettings.jsonpCallback;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Save the callback name for future use</span></span><br><span class="line">                oldCallbacks.push( callbackName );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call if it was a function and we have a response</span></span><br><span class="line">            <span class="keyword">if</span> ( responseContainer &amp;&amp; jQuery.isFunction( overwritten ) ) &#123;</span><br><span class="line">                overwritten( responseContainer[ <span class="number">0</span> ] );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            responseContainer = overwritten = <span class="literal">undefined</span>;</span><br><span class="line">        &#125; );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegate to script</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"script"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是判断我们自定义的属性是不是有jsonp<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle iff the expected data type is "jsonp" or we have a parameter to set</span></span><br><span class="line"><span class="keyword">if</span> ( jsonProp || s.dataTypes[ <span class="number">0</span> ] === <span class="string">"jsonp"</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get callback name, remembering preexisting value associated with it</span></span><br><span class="line">    callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?</span><br><span class="line">        s.jsonpCallback() :</span><br><span class="line">        s.jsonpCallback;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">            to be continued</span><br><span class="line">        */</span></span><br></pre></td></tr></table></figure></p>
<p><code>s.jsonpCallback</code>是我们在jsonp.js里面传入的<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jsonpCallback: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">callback</span> = oldCallbacks.pop() || ( jQuery.expando + <span class="string">"_"</span> + ( nonce++ ) );</span><br><span class="line">    <span class="keyword">this</span>[ <span class="keyword">callback</span> ] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">callback</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际是把我们传入的回调函数返回出来，否则就返回一串随机数，像<code>jQuery22105127492309547961_1457270695408</code>这样的玩意</p>
<p>然后就到最关键的部分了<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// <span class="constant">Insert</span> callback into url <span class="keyword">or</span> form data</span><br><span class="line"><span class="keyword">if</span> ( jsonProp <span class="keyword">) &#123;</span></span><br><span class="line">    s[ jsonProp ] = s[ jsonProp ].<span class="literal">replace</span>( rjsonp, <span class="string">"$1"</span> + callbackName );</span><br><span class="line"><span class="keyword">&#125;</span> <span class="keyword">else</span> <span class="keyword">if</span> ( s.jsonp !== <span class="keyword">false</span> <span class="keyword">) &#123;</span></span><br><span class="line">    s.url += ( rquery.test( s.url ) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span> ) + s.jsonp + <span class="string">"="</span> + callbackName;</span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>s.url在这里会变成像这样的<code>https://github.com/dengal3?callback=jQuery22105127492309547961_1457270695408</code>类似的玩意，这是因为我没有传callback函数，所以才会有这么一堆随机数的，但是关键的是这里产生了一个“？callback=”这样的玩意。</p>
<p>接着看jsonp.js的代码<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 57</span></span><br><span class="line"><span class="comment">// Force json dataType</span></span><br><span class="line">s.dataTypes[ <span class="number">0</span> ] = <span class="string">"json"</span>;</span><br></pre></td></tr></table></figure></p>
<p>这里强制把json改回来，传入的匿名函数返回的是“script”<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">( dataType )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selected;</span><br><span class="line">    inspected[ dataType ] = <span class="literal">true</span>;</span><br><span class="line">    jQuery.<span class="keyword">each</span>( structure[ dataType ] || [], <span class="function"><span class="keyword">function</span><span class="params">( _, prefilterOrFactory )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> dataTypeOrTransport === <span class="string">"string"</span> &amp;&amp;</span><br><span class="line">            !seekingTransport &amp;&amp; !inspected[ dataTypeOrTransport ] ) &#123;</span><br><span class="line"></span><br><span class="line">            options.dataTypes.unshift( dataTypeOrTransport );</span><br><span class="line">            inspect( dataTypeOrTransport );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( seekingTransport ) &#123;</span><br><span class="line">            <span class="keyword">return</span> !( selected = dataTypeOrTransport );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即这里的dataTypeOrTransport是“script”，然后<code>options.dataTypes.unshift( dataTypeOrTransport );</code>会把dataTypes变为{“script”， “json”}，“json”刚刚是被强制加上去的。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inspect<span class="list">( <span class="keyword">dataTypeOrTransport</span> )</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>structure[“script”]此时是在另一个ajaxSetup里面配置好的（在script.js里面）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Install script dataType</span></span><br><span class="line">jQuery.ajaxSetup( &#123;</span><br><span class="line">    accepts: &#123;</span><br><span class="line">        script: <span class="string">"text/javascript, application/javascript, "</span> +</span><br><span class="line">            <span class="string">"application/ecmascript, application/x-ecmascript"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    contents: &#123;</span><br><span class="line">        script: <span class="regexp">/\b(?:java|ecma)script\b/</span></span><br><span class="line">    &#125;,</span><br><span class="line">    converters: &#123;</span><br><span class="line">        <span class="string">"text script"</span>: <span class="function"><span class="keyword">function</span><span class="params">( text )</span> </span>&#123;</span><br><span class="line">            jQuery.globalEval( text );</span><br><span class="line">            <span class="keyword">return</span> text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle cache's special case and crossDomain</span></span><br><span class="line">jQuery.ajaxPrefilter( <span class="string">"script"</span>, <span class="function"><span class="keyword">function</span><span class="params">( s )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( s.cache === <span class="literal">undefined</span> ) &#123;</span><br><span class="line">        s.cache = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( s.crossDomain ) &#123;</span><br><span class="line">        s.type = <span class="string">"GET"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure></p>
<p>这里的ajaxPrefilter中的匿名函数就是用于crossDomain，跨域用的。</p>
<p>待续<br>我感觉还是没写好，之后再修改。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/12/2016-03-12-说说有关setTimeout的那些事/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          有关setTimeout的那些事
        
      </div>
    </a>
  
  
    <a href="/2015/07/24/2015-7-24-note/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">2015-7-24 note</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2016-03-06-Jquery源码之jsonp" data-title="JQuery中的jsonp源码剖析" data-url="http://dengal3.github.com/2016/03/06/2016-03-06-Jquery源码之jsonp/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 ailin
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>